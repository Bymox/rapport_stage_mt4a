<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spurious interactif — architecture_verif</title>
<style>
  /* Refined pastel theme (dark enforced) */
  :root{
    --bg:#071026;
    --card:#081428;
    --muted:#9aa3b2;
    --text:#e6eef6;
    --accent:#4aa3e0;
    --accent-2:#7ad3b7;
    --danger:#e06b6b;
    --success:#46b16b;
    --panel-border:#0f2b3a;
    --mono-bg:#06101a;
    --glass: rgba(74,163,224,0.06);
    --radius:12px;
    --gap:12px;
    --code-font: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  }

  html,body{height:106%;margin:0;font-family:system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  body{padding:18px}

  /* header */
  .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px}
  .title-block{display:flex;align-items:flex-start;gap:12px}
  h1{margin:0;font-size:2.0rem}
  .small{font-size:0.88rem;color:var(--muted)}

  /* subtle glass card */
  .card{background:var(--card);border:1px solid var(--panel-border);border-radius:var(--radius);padding:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}

  /* Layout grid: LEFT 45% RIGHT 55% ; top row smaller so params not huge */
  .layout {
    display:grid;
    grid-template-columns:45% 55%;
    grid-template-rows:62% 54%;   /* avant 28/72 → +4% pour params */
    gap:var(--gap);
    height:calc(100vh - 120px);
  }
  .params{grid-column:1/2;grid-row:1/2;display:flex;flex-direction:column;gap:10px;min-height:200px;max-height:460px;overflow:auto}
  .power-table{grid-column:1/2;grid-row:2/3;overflow:auto}
  .results{grid-column:2/3;grid-row:1/3;overflow:auto}

  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{min-width:120px;color:var(--text);font-size:0.95rem}

  input[type=number], select, input[type=text]{padding:6px;border-radius:8px;border:1px solid var(--panel-border);font-size:0.88rem;background:var(--mono-bg);color:var(--text);min-height:20px}
  input[type=number]::placeholder, input[type=text]::placeholder{color:var(--muted)}
  input[type=range]{width:140px}

  /* table styles */
  table{border-collapse:collapse;width:100%}
  #power_table{table-layout:fixed;border-collapse:collapse;width:100%;background:transparent}
  #power_table th,#power_table td{border:1px solid var(--panel-border);padding:8px;text-align:center;font-size:0.92rem;white-space:nowrap}
  #power_table thead th{background:transparent;font-weight:600}
  #power_table td input{width:64px;padding:6px;border-radius:8px;border:1px solid var(--panel-border);text-align:center;font-size:0.92rem;background:transparent;color:var(--text)}

  /* highlight empty cells to show missing data */
  .missing-cell{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0));border-radius:8px}

  /* buttons */
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#06121a;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:0.92rem;box-shadow:0 6px 16px rgba(74,163,224,0.12)}
  .btn:hover{transform:translateY(-2px)}
  .btn-ghost{background:transparent;color:var(--accent);border:1px solid rgba(74,163,224,0.12);cursor:pointer;padding:7px 10px;border-radius:10px;font-size:0.9rem}

  .actions{display:flex;gap:8px;align-items:center}

  #spurious_list table{width:100%;border-collapse:collapse;font-size:0.93rem}
  #spurious_list th,#spurious_list td{border:1px solid var(--panel-border);padding:8px;text-align:center}
  #spurious_list tr:nth-child(even){background:rgba(255,255,255,0.02)}

  .compact{font-size:0.92rem}
  footer{margin-top:12px;font-size:0.9rem;color:var(--muted)}

  /* mini schematic */
  .svg-rf{fill:rgba(255,120,120,0.08);stroke:rgba(255,255,255,0.02)}
  .svg-fi{fill:rgba(120,255,180,0.06);stroke:rgba(255,255,255,0.02)}
  .svg-ol{fill:rgba(255,230,180,0.06);stroke:rgba(255,255,255,0.02)}

  /* focus states for accessibility */
  :focus{outline:none}
  input:focus, select:focus, button:focus, a:focus{box-shadow:0 0 0 4px rgba(74,163,224,0.12);border-color:var(--accent)}

  /* responsive */
  @media (max-width:980px){
    .layout{grid-template-columns:1fr;grid-template-rows:auto auto auto;height:auto}
    .results{grid-column:1/2;grid-row:3/4}
    #power_table td input{width:46px}
  }

  .hint{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body data-theme="dark">

<!-- header: title left, lang selector right (theme fixed dark) -->
<div class="header">
  <div class="title-block">
    <div>
      <h1 data-i18n="title">Spurious — outil interactif</h1>
      <div class="small" data-i18n="subtitle">Les calculs se mettent à jour automatiquement à la saisie.</div>
    </div>
  </div>
  <!-- <div style="display:flex;gap:8px;align-items:center">
    <select id="lang" title="Langue" style="padding:8px;border-radius:8px;border:1px solid var(--panel-border);background:var(--mono-bg);color:var(--text)">
      <option value="fr">FR</option>
      <option value="en">EN</option>
    </select>
    <select id="theme" title="Thème" style="padding:8px;border-radius:8px;border:1px solid var(--panel-border);background:var(--mono-bg);color:var(--text)" disabled>
      <option value="dark">🌙</option>
    </select>
  </div> -->
</div>

<div class="layout">
      <!-- TOP LEFT : paramètres + petit mixeur -->
      
      <div class="card params">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <!-- Bloc titre -->
      <div>
        <strong data-i18n="params_title">Paramètres</strong>
        <div class="small" data-i18n="params_sub">Saisir les plages / bornes</div>
      </div>

      <!-- Boutons à droite -->
      <div class="actions" style="display:flex;gap:8px;">
        <button id="reset_params" class="btn-ghost" data-i18n="reset_btn">Réinitialiser</button>
        <button id="clear_params" class="btn-ghost" data-i18n="clear_all">Vider</button>
      </div>
    </div>


    <div style="margin-top:8px" class="compact">
      <div class="row" style="margin-bottom:8px">
        <label data-i18n="rf_range">Plage RF (MHz) :</label>
        <input id="rf_min" type="number" value="6000" placeholder="min"> →
        <input id="rf_max" type="number" value="18000" placeholder="max">
      </div>

      <div class="row" style="margin-bottom:8px">
        <label data-i18n="ol_fixed">OL fixe (MHz) :</label>
        <input id="ol" type="number" value="10000" placeholder="OL">
      </div>

      <div class="row" style="margin-bottom:8px">
        <label data-i18n="mode_label">Mode :</label>
        <select id="mode" style="width:180px">
          <option value="supradyne">supradyne (OL &gt; RF)</option>
          <option value="infradyne">infradyne (OL &lt; RF)</option>
        </select>
      </div>

      <div class="row" style="margin-bottom:8px">
        <label data-i18n="fi_range">Plage FI (MHz) :</label>
        <input id="fi_min" type="number" value="3500" placeholder="min"> →
        <input id="fi_max" type="number" value="4500" placeholder="max">
      </div>

      <div class="row" style="margin-bottom:8px">
        <label data-i18n="m_max">m_max (±) :</label>
        <input id="m_max" type="number" value="3" min="0" max="30" style="width:96px">
        <label style="min-width:78px;margin-left:8px" data-i18n="n_max">n_max (±) :</label>
        <input id="n_max" type="number" value="3" min="0" max="30" style="width:96px">
      </div>
    </div>

    <!-- petit schéma mixeur -->
    <div style="margin-top:12px">
  <svg width="100%" height="120" viewBox="0 0 360 120" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="mixTitleSmall">
    <title id="mixTitleSmall">Mini schéma mixeur</title>
    <defs>
      <marker id="arrowSmall" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
        <path d="M0,0 L8,4 L0,8 z" fill="#666"/>
      </marker>
    </defs>

    <!-- RF left -->
    <rect x="12" y="18" width="64" height="28" rx="6" class="svg-rf"/>
    <text x="44" y="36" font-size="12" text-anchor="middle" fill="var(--text)">RF</text>
    <line x1="76" y1="32" x2="112" y2="32" stroke="#888" stroke-width="2" marker-end="url(#arrowSmall)"/>

    <!-- MIX center -->
    <g>
      <circle cx="148" cy="32" r="28" fill="var(--mono-bg)" stroke="var(--panel-border)"/>
      <line x1="132" y1="16" x2="164" y2="48" stroke="#c33" stroke-width="2.5"/>
      <line x1="164" y1="16" x2="132" y2="48" stroke="#c33" stroke-width="2.5"/>
    </g>

    <!-- FI right -->
    <line x1="176" y1="32" x2="212" y2="32" stroke="#888" stroke-width="2" marker-end="url(#arrowSmall)"/>
    <rect x="212" y="20" width="64" height="28" rx="6" class="svg-fi"/>
    <text x="244" y="38" font-size="12" text-anchor="middle" fill="var(--text)">FI</text>

    <!-- OL bottom -->
    <rect x="116" y="88" width="64" height="22" rx="6" class="svg-ol"/>
    <text x="148" y="104" font-size="11" text-anchor="middle" fill="var(--text)">OL</text>
    <line x1="148" y1="88" x2="148" y2="60" stroke="#888" stroke-width="2" marker-end="url(#arrowSmall)"/>
  </svg>
</div>

  </div>

  <!-- BOTTOM LEFT : table 5x6 -->
  <div class="card power-table">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <strong data-i18n="table_title">Table puissances spurious (dBc)</strong>
        <div class="small" data-i18n="table_hint">m = 1..5, n = 0..5</div>
      </div>
      <div class="actions">
        <button id="reset_table" class="btn-ghost" data-i18n="reset_table">Réinitialiser</button>
        <button id="clear_table" class="btn-ghost" data-i18n="clear_table">Vider</button>
        <button id="download_csv" class="btn" data-i18n="download_csv">Télécharger CSV</button>
      </div>
    </div>

    <div style="overflow:auto;max-height:calc(72vh - 160px)">
      <table id="power_table" aria-label="table puissance spurious"></table>
    </div>

    <div style="margin-top:8px" class="hint" data-i18n="table_note">
      Si une cellule est vide, la puissance n'est pas disponible pour ce couple (m,n).
    </div>
  </div>

  <!-- RIGHT (full height) : résultats -->
  <div class="card results">
    <h3 style="margin:0 0 8px" data-i18n="results_title">Résultats (tous couples)</h3>
    <div id="summary" class="small muted" style="margin-bottom:8px" data-i18n="no_calc">Aucun calcul</div>

    <div id="spurious_list" style="font-size:13px;line-height:1.25;"></div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="download_report_right" class="btn" data-i18n="download_report">Télécharger rapport</button>
      <button id="copy_report_right" class="btn-ghost" data-i18n="copy_report">Copier</button>
    </div>

    <div style="margin-top:12px" class="small" data-i18n="author">Auteur : <strong>François Bordas</strong> — <a href="mailto:francois.bordas@etu.univ-amu.fr">francois.bordas@etu.univ-amu.fr</a></div>
  </div>
</div>

<script>
/* ---------- i18n strings (FR/EN) ---------- */
const I18N = {
  fr: {
    title: "Spurious — outil interactif",
    subtitle: "Les calculs se mettent à jour automatiquement à la saisie.",
    lang:"Langue",
    params_title: "Paramètres",
    params_sub: "Saisir les plages / bornes",
    reset_btn: "Réinitialiser",
    clear_all: "Vider",
    rf_range: "Plage RF (MHz) :",
    ol_fixed: "OL fixe (MHz) :",
    mode_label: "Mode :",
    fi_range: "Plage FI (MHz) :",
    m_max: "m_max (±) :",
    n_max: "n_max (±) :",
    table_title: "Table puissances spurious (dBc) — 5×6",
    table_hint: "m = 1..5, n = 0..5",
    reset_table: "Réinitialiser",
    clear_table: "Vider",
    download_csv: "Télécharger CSV",
    table_note: "Si une cellule est vide, la puissance n'est pas disponible pour ce couple (m,n).",
    results_title: "Résultats (tous couples)",
    no_calc: "Aucun calcul",
    download_report: "Télécharger rapport",
    copy_report: "Copier",
    author: "Auteur : <strong>François Bordas</strong> — <a href=\"mailto:francois.bordas@etu.univ-amu.fr\">francois.bordas@etu.univ-amu.fr</a>"
  },
  en: {
    title: "Spurious — interactive tool",
    subtitle: "Calculations update automatically while you type.",
    params_title: "Parameters",
    lang:"Language",
    params_sub: "Enter ranges / bounds",
    reset_btn: "Reset",
    clear_all: "Clear",
    rf_range: "RF range (MHz):",
    ol_fixed: "Fixed LO (MHz):",
    mode_label: "Mode:",
    fi_range: "IF range (MHz):",
    m_max: "m_max (±):",
    n_max: "n_max (±):",
    table_title: "Spurious power table (dBc) — 5×6",
    table_hint: "m = 1..5, n = 0..5",
    reset_table: "Reset",
    clear_table: "Clear",
    download_csv: "Download CSV",
    table_note: "If a cell is empty, the power is not available for that (m,n) pair.",
    results_title: "Results (all pairs)",
    no_calc: "No calculation",
    download_report: "Download report",
    copy_report: "Copy",
    author: "Author: <strong>François Bordas</strong> — <a href=\"mailto:francois.bordas@etu.univ-amu.fr\">francois.bordas@etu.univ-amu.fr</a>"
  }
};

function applyLang(lang){
  const dict = I18N[lang] || I18N.fr;
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (!key) return;
    if (key === 'author') { el.innerHTML = dict[key]; return; }
    el.textContent = dict[key];
  });
}

function applyTheme(theme){
  // theme locked to dark
  document.body.setAttribute('data-theme','dark');
}

/* ---------- table par défaut (unchanged) ---------- */
const DEFAULT_TABLE = [
  [-29,  " -ref", -23, -10, -21, -19],
  [-85,  -61,    -73, -65, -71, -69],
  [-84,  -68,    -88, -81, -87, -78],
  [-114, -109,   -116, -115, -116, -115],
  [-119, -123,   -128, -126, -127, -128]
];

function buildFixedPowerTable(prefill = null){
  const tbl = document.getElementById('power_table');
  tbl.innerHTML = '';
  const header = document.createElement('tr');
  header.innerHTML = '<th style="width:66px">m \ n</th>' + Array.from({length:6},(_,i)=>`<th style="width:64px">n=${i}</th>`).join('');
  tbl.appendChild(header);
  for (let r=0;r<5;r++){
    const tr = document.createElement('tr');
    const th = document.createElement('td'); th.textContent = `m=${r+1}`; tr.appendChild(th);
    for (let c=0;c<6;c++){
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type='text'; inp.className='mono';
      inp.style.width='64px';
      inp.style.boxSizing='border-box';
      inp.dataset.r = r; inp.dataset.c = c;
      if (prefill && prefill[r] && prefill[r][c] !== undefined && prefill[r][c] !== null){
        inp.value = String(prefill[r][c]);
      }
      td.appendChild(inp); tr.appendChild(td);
    }
    tbl.appendChild(tr);
  }
}

function parseFixedPowerTable(){
  const tbl = document.getElementById('power_table');
  const rows = Array.from(tbl.querySelectorAll('tr')).slice(1);
  const data = rows.map(tr => Array.from(tr.querySelectorAll('td input')).map(inp=>{
    const v = inp.value.trim();
    if (v === '') return null;
    const n = Number(v);
    if (!Number.isNaN(n)) return n;
    return null;
  }));
  return data;
}

function getPowerFromFixedTable(m,n,table){
  const im = Math.abs(m)-1;
  const inIdx = Math.abs(n);
  if (im < 0 || im >= 5 || inIdx < 0 || inIdx >= 6) return null;
  const val = table[im][inIdx];
  return (val === null) ? null : val;
}

function computeImageRange(params){
  if (params.mode === 'supradyne') return [params.ol + params.fi_min, params.ol + params.fi_max];
  return [params.ol - params.fi_max, params.ol - params.fi_min];
}

function computeRanges(params, table){
  const res = [];
  const {m_max, n_max, ol, fi_min, fi_max, rf_min, rf_max, mode} = params;
  for (let m = -m_max; m <= m_max; m++){
    for (let n = -n_max; n <= n_max; n++){
      if (m===0 && n===0) continue;
      let lo_c=null, hi_c=null;
      try {
        if (m===0){
          const FI = Math.abs(n * ol);
          if (!(FI >= fi_min && FI <= fi_max)) continue;
          lo_c = rf_min; hi_c = rf_max;
        } else if (n===0){
          const lo = fi_min / Math.abs(m);
          const hi = fi_max / Math.abs(m);
          const lo_sorted = Math.min(lo,hi), hi_sorted = Math.max(lo,hi);
          lo_c = Math.max(lo_sorted, rf_min);
          hi_c = Math.min(hi_sorted, rf_max);
          if (lo_c > hi_c) continue;
        } else {
          const rf1 = (fi_min - n*ol)/m;
          const rf2 = (fi_max - n*ol)/m;
          const lo = Math.min(rf1, rf2), hi = Math.max(rf1, rf2);
          lo_c = Math.max(lo, rf_min);
          hi_c = Math.min(hi, rf_max);
          if (lo_c > hi_c) continue;
        }
      } catch(e){ continue; }
      let label = 'spurious';
      if (m===0 || n===0) label = 'fuite';
      else if ((mode === 'supradyne' && m===-1 && n===1) || (mode==='infradyne' && m===1 && n===-1)) label='utile';
      else if ((mode === 'supradyne' && m===1 && n===-1) || (mode==='infradyne' && m===-1 && n===1)) label='image';
      const power = getPowerFromFixedTable(m,n,table);
      res.push({m,n,type:label,RF_min:Number(lo_c.toFixed(3)),RF_max:Number(hi_c.toFixed(3)),power});
    }
  }
  return res;
}

function sortSpurious(list, tableProvided){
  if (!Array.isArray(list)) return;
  if (tableProvided){
    list.sort((a,b)=>{
      const pa = (a.power===null||a.power===undefined)? Infinity : a.power;
      const pb = (b.power===null||b.power===undefined)? Infinity : b.power;
      if (pa !== pb) return pa - pb;
      const ca = Math.abs(a.m)+Math.abs(a.n), cb = Math.abs(b.m)+Math.abs(b.n);
      if (ca !== cb) return ca - cb;
      if (Math.abs(a.m)!==Math.abs(b.m)) return Math.abs(a.m)-Math.abs(b.m);
      return Math.abs(a.n)-Math.abs(b.n);
    });
  } else {
    list.sort((a,b)=>{
      const ca = Math.abs(a.m)+Math.abs(a.n), cb = Math.abs(b.m)+Math.abs(b.n);
      if (ca !== cb) return ca - cb;
      if (Math.abs(a.m)!==Math.abs(b.m)) return Math.abs(a.m)-Math.abs(b.m);
      return Math.abs(a.n)-Math.abs(b.n);
    });
  }
}

/* Render results into the right column (unchanged logic) */
function renderResults(){
  const rf_min = Number(document.getElementById('rf_min').value);
  const rf_max = Number(document.getElementById('rf_max').value);
  const ol = Number(document.getElementById('ol').value);
  const fi_min = Number(document.getElementById('fi_min').value);
  const fi_max = Number(document.getElementById('fi_max').value);
  let m_max = Number(document.getElementById('m_max').value);
  let n_max = Number(document.getElementById('n_max').value);
  m_max = Math.min(30, Math.max(0, Math.round(m_max)));
  n_max = Math.min(30, Math.max(0, Math.round(n_max)));
  const mode = document.getElementById('mode').value;
  if (!(rf_min < rf_max && fi_min < fi_max)) {
    document.getElementById('summary').innerHTML = '<span class="muted">Vérifier les plages RF et FI (min < max)</span>';
    document.getElementById('spurious_list').innerHTML = ''; return;
  }
  const tableRaw = parseFixedPowerTable();
  const tableProvided = tableRaw.some(r=>r.some(c=>c!==null));
  const params = {rf_min, rf_max, ol, fi_min, fi_max, m_max, n_max, mode};
  const results = computeRanges(params, tableRaw);
  const groups={utile:[],image:[],spurious:[],fuite:[]};
  results.forEach(r=> groups[r.type].push(r));
  sortSpurious(groups.spurious, tableProvided);
  const imrange = computeImageRange(params);

  document.getElementById('summary').innerHTML = `<div><strong>Total couples:</strong> ${results.length}</div>
    <div class="small">Utile: ${groups.utile.length} • Image: ${groups.image.length} • Spurious: ${groups.spurious.length} • Fuite: ${groups.fuite.length}</div>
    <div class="small">Plage image: ${imrange[0].toFixed(2)} — ${imrange[1].toFixed(2)} MHz (${mode})</div>`;

  const spDiv = document.getElementById('spurious_list'); spDiv.innerHTML='';
  // Spurious table
  if (groups.spurious.length===0) spDiv.innerHTML = '<div class="muted">Aucun spurious détecté</div>';
  else {
    const t = document.createElement('table');
    const showPowerCol = tableProvided;
    t.innerHTML = `<tr><th>m</th><th>n</th><th>RF_min (MHz)</th><th>RF_max (MHz)</th>${showPowerCol?'<th>power (dBc)</th>':''}</tr>`;
    groups.spurious.forEach(s=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${s.m}</td><td>${s.n}</td><td>${s.RF_min}</td><td>${s.RF_max}</td>${showPowerCol?`<td>${s.power==null?'':s.power}</td>`:''}`;
      t.appendChild(tr);
    });
    spDiv.appendChild(t);
  }

  // then the other groups (utile,image,fuite)
  const sec = document.createElement('div'); sec.style.marginTop='12px';
  ['utile','image','fuite'].forEach(k=>{
    const arr = groups[k];
    const block = document.createElement('div');
    block.innerHTML = `<strong>${k.toUpperCase()}</strong> (${arr.length})`;
    if (arr.length){
      const t=document.createElement('table');
      t.style.marginTop='6px';
      t.innerHTML = `<tr><th>m</th><th>n</th><th>RF_min</th><th>RF_max</th></tr>`;
      arr.forEach(s => { const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.m}</td><td>${s.n}</td><td>${s.RF_min}</td><td>${s.RF_max}</td>`; t.appendChild(tr); });
      block.appendChild(t);
    }
    sec.appendChild(block);
  });
  spDiv.appendChild(sec);

  window._lastReport = {params, results, tableProvided};
}

/* report generation & download (unchanged) */
function generateReportText(){
  const last = window._lastReport;
  if (!last) return 'Aucun calcul disponible';
  const p = last.params; const results = last.results;
  const lines = [];
  lines.push('=== Spurious report ===');
  lines.push(`RF_range: ${p.rf_min} - ${p.rf_max} MHz`);
  lines.push(`OL: ${p.ol} MHz ; FI: ${p.fi_min} - ${p.fi_max} MHz ; mode: ${p.mode}`);
  lines.push('');
  lines.push('=== direct leak checks ===');
  if (p.ol >= p.fi_min && p.ol <= p.fi_max) lines.push("❌ OL DANS FI");
  else lines.push("✅ OL HORS FI");
  if (!(p.rf_max < p.fi_min || p.rf_min > p.fi_max)) lines.push("❌ RF chevauche FI");
  else lines.push("✅ RF hors FI");
  lines.push('');
  const grp={utile:[],image:[],spurious:[],fuite:[]};
  results.forEach(r=> grp[r.type].push(r));
  lines.push('=== Utile ==='); lines.push(`count ${grp.utile.length}`); grp.utile.forEach(u=>lines.push(`${u.m},${u.n},${u.RF_min},${u.RF_max}`));
  lines.push('');
  lines.push('=== Image ==='); lines.push(`count ${grp.image.length}`); grp.image.forEach(u=>lines.push(`${u.m},${u.n},${u.RF_min},${u.RF_max}`));
  lines.push('');
  lines.push('=== Spurious (triés) ==='); lines.push(`count ${grp.spurious.length}`); grp.spurious.forEach(s=>lines.push(`${s.m},${s.n},${s.RF_min},${s.RF_max},${s.power==null?'':s.power}`));
  lines.push('');
  return lines.join('');
}

function downloadReportAsFile(name='spurious_report.txt'){
  const txt = generateReportText();
  const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- UI interactions (updated wiring for instant updates + small UX niceties) ---------- */
function attachHandlers(){
  const ids = ['rf_min','rf_max','ol','fi_min','fi_max','m_max','n_max','mode'];
  // instant updates: directly call renderResults on input (no debounce) to keep calculations instant
  ids.forEach(id => { const el = document.getElementById(id); if(el) el.addEventListener('input', renderResults); });

  // table inputs: delegate input events so any change updates results immediately
  document.getElementById('power_table').addEventListener('input', (ev)=>{
    // mark empty inputs with visual hint
    const inp = ev.target; if (inp && inp.tagName === 'INPUT'){
      if (inp.value.trim() === '') inp.classList.add('missing-cell'); else inp.classList.remove('missing-cell');
    }
    renderResults();
  });

  // language selector (optionnel)
  const langSelect = document.getElementById('lang');
  if (langSelect) {
    langSelect.addEventListener('change', (ev) => {
      applyLang(ev.target.value);
    });
  }

  // toujours appliquer la langue par défaut même si pas de select
  applyLang('fr');


  const themeSelect = document.getElementById('theme');
  if (themeSelect) {
    themeSelect.value = 'dark';
    themeSelect.disabled = true;
    // si tu veux garder le listener (optionnel)
    themeSelect.addEventListener('change', (ev) => {
      applyTheme(ev.target.value);
    });
  }

  // report buttons
  document.getElementById('download_report_right').addEventListener('click', ()=> downloadReportAsFile());
  document.getElementById('copy_report_right').addEventListener('click', ()=> {
    const txt = generateReportText();
    navigator.clipboard?.writeText(txt).then(()=> { const b=document.getElementById('copy_report_right'); b.textContent='Copié ✓'; setTimeout(()=> b.textContent='Copier',1200); }, ()=> alert('Échec copie'));
  });

  // PARAMS section buttons (only affect params)
  document.getElementById('reset_params').addEventListener('click', ()=> {
    document.getElementById('rf_min').value=6000; document.getElementById('rf_max').value=18000;
    document.getElementById('ol').value=10000; document.getElementById('fi_min').value=3500; document.getElementById('fi_max').value=4500;
    document.getElementById('m_max').value=3; document.getElementById('n_max').value=3; document.getElementById('mode').value='supradyne';
    renderResults();
  });

  document.getElementById('clear_params').addEventListener('click', ()=>{
    document.getElementById('rf_min').value=''; document.getElementById('rf_max').value='';
    document.getElementById('ol').value=''; document.getElementById('fi_min').value=''; document.getElementById('fi_max').value='';
    document.getElementById('m_max').value=''; document.getElementById('n_max').value=''; document.getElementById('mode').value='supradyne';
    renderResults();
  });

  // TABLE section buttons (only affect the power table)
  document.getElementById('reset_table').addEventListener('click', ()=>{ buildFixedPowerTable(DEFAULT_TABLE); renderResults(); highlightMissingCells(); });
  document.getElementById('clear_table').addEventListener('click', ()=>{ buildFixedPowerTable([[null,null,null,null,null,null],[null,null,null,null,null,null],[null,null,null,null,null,null],[null,null,null,null,null,null],[null,null,null,null,null,null]]); renderResults(); highlightMissingCells(); });

  document.getElementById('download_csv').addEventListener('click', ()=> {
    const table = parseFixedPowerTable();
    const header = ['n0','n1','n2','n3','n4','n5'];
    const lines = [header.join(',')].concat(table.map(r => r.map(v => (v===null? '' : v)).join(',')));
    const blob = new Blob([lines.join('')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='power_table.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // visual nicety: highlight missing cells after initial build
  highlightMissingCells();
}

function highlightMissingCells(){
  const inputs = document.querySelectorAll('#power_table td input');
  inputs.forEach(inp=>{ if (inp.value.trim() === '') inp.classList.add('missing-cell'); else inp.classList.remove('missing-cell'); });
}

function debounce(fn, ms=200){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* init */
buildFixedPowerTable(DEFAULT_TABLE);
attachHandlers();
applyLang('fr');
applyTheme('dark');
renderResults();
</script>
</body>
</html>
