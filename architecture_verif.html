<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RF Chain Calculator — calcul instantané</title>
<style>
:root {
  --bg: #071026;
  --card-bg: #081428;
  --panel-border: #0f2b3a;
  --text: #e6eef6;
  --muted: #9aa3b2;
  --accent: #4aa3e0;
  --accent-strong: #7ad3b7;
  --mono-bg: #06101a;
  --danger: #e06b6b;
  --type-ampli: #4a90e2;
  --type-filter: #7ad3b7;
  --type-attenuator: #e06b6b;
  --type-mixer: #f5a623;
  --type-switch: #9b59b6;
}

body {
  margin: 0;
  padding: 16px;
  line-height: 1.5;
  background: var(--bg);
  color: var(--text);
  font-family: 'Segoe UI', Roboto, sans-serif;
}

header {
  margin-bottom: 16px;
}

h1 {
  font-size: 1.5rem;
  margin: 0 0 4px;
}

.small {
  font-size: 0.85rem;
  color: var(--muted);
}

.layout {
  display: grid;
  grid-template-columns: 650px 450px 350px;
  gap: 16px;
  margin-top: 12px;
  margin-bottom: 5px;
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--panel-border);
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.stage-card {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid var(--panel-border);
  border-radius: 18px;
  padding: 12px;
  margin-bottom: 4px;
  position: relative;
  border-left: 4px solid var(--type-ampli);
}

.stage-card[data-type="filter"] {
  border-left-color: var(--type-filter);
}

.stage-card[data-type="atten"] {
  border-left-color: var(--type-attenuator);
}

.stage-card[data-type="mixer"] {
  border-left-color: var(--type-mixer);
}

.stage-card[data-type="switch"] {
  border-left-color: var(--type-switch);
}

.stage-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 3px;
}

.stage-name {
  font-weight: 600;
  color: var(--accent);
}

.controls {
  margin-bottom: 12px;
}
.stage-controls {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2px;
}

.stage-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

label {
  min-width: 100px;
  font-size: 0.9rem;
}

input, select {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid var(--panel-border);
  background: var(--mono-bg);
  color: var(--text);
  font-size: 0.9rem;
}

.stage-card .stage-name .s_name {
  background: transparent;
  border: 0;
  outline: none;
  color: var(--accent);
  font-weight: 600;
  width: 140px;         /* ajuste la largeur */
  cursor: text;
  border-bottom: 1px dashed transparent;
  transition: background .2s, border-bottom-color .2s;
}

.stage-card .stage-name .s_name:hover,
.stage-card .stage-name .s_name:focus {
  background: rgba(255,255,255,.06);
  border-bottom-color: var(--accent);
}


button {
  padding: 6px 12px;
  border-radius: 6px;
  border: 0;
  background: var(--accent);
  color: white;
  cursor: pointer;
  font-size: 0.9rem;
}

button.ghost {
  background: transparent;
  color: var(--accent);
  border: 1px solid var(--accent);
}

:root {
  --field-w: 100px; /* largeur standard des champs numériques */
  --name-w: 150px;  /* largeur du champ nom */
}

/* Cible les vrais éléments et force la largeur malgré l'inline */
#stagesContainer .stage-card .stage-row input[type="number"],
#stagesContainer .stage-card .stage-row select {
  width: var(--field-w) !important;
  flex: 0 0 var(--field-w); /* évite que le flex étire à 100% */
}

#stagesContainer .stage-card .stage-row .s_name {
  width: var(--name-w) !important;
  flex: 0 0 var(--name-w);
}


button.remove {
  background: var(--danger);
  padding: 4px 8px;
  font-size: 0.8rem;
}

.edit-icon {
  margin-right: 6px;
  font-size: 14px;
  color: #666;
  cursor: pointer;
}


.results-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.metric {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid var(--panel-border);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}

.metric .val {
  font-size: 1.2rem;
  font-weight: 700;
  margin-top: 4px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

th, td {
  padding: 8px;
  text-align: center;
  border: 1px solid var(--panel-border);
  font-size: 0.9rem;
}

th {
  background: rgba(0, 0, 0, 0.3);
  color: var(--accent);
}

.stages-scroll {
  max-height: 750px;
  overflow-y: auto;
  padding-right: 8px;
}

.eq-block {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid var(--panel-border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.eq-title {
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--accent);
}

@media (max-width: 980px) {
  .layout {
    grid-template-columns: 1fr;
  }
}



/* conteneur scrollable autour du tableau */
.table-wrap {
  max-height: 580px;
  overflow-y: auto;
  overflow-x: hidden;
  border-radius: 8px;
  /* léger séparateur pour mieux voir la zone */
  border: 1px solid rgba(255,255,255,0.03);
}

/* garantir largeur et rendu correct de la table à l'intérieur */
.table-wrap table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed; /* optionnel : évite que colonnes se redimensionnent étrangement */
}

/* rendre l'entête collant (reste visible au scroll) */
.table-wrap thead th {
  position: sticky;
  top: 0;
  z-index: 3;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), var(--card-bg));
  /* s'assurer que le texte reste lisible */
  color: var(--accent);
}

.col_type {
  width: 100px;
}
/* si tu veux, ajuster alignement et overflow sur les cellules */
.table-wrap td,
.table-wrap th {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

</style>

</head>
<body data-theme="dark">
  <header>
    <div>
      <h1 id="title">RF Chain Calculator — calcul instantané</h1>
      <div id="subtitle" class="small">Gain / NF / OP1dB & IP1dB — interface interactive</div>
    </div>
  </header>
  <div class="layout">
    <!-- Colonne gauche : Étages -->
    <div class="card">
      <div class="controls">
        <label id="label_n">Nombre d'étages :</label>

        <div style="display:inline-flex;align-items:center;gap:6px;">
          <button id="btnRemove" class="ghost" title="Retirer un étage">−</button>
          <input id="nStagesInput" type="number" inputmode="numeric" min="0" max="100" step="1"
                value="5" style="width:64px;padding:6px;border-radius:6px;border:1px solid var(--panel-border);background:var(--mono-bg);color:var(--text)">
          <button id="btnAdd" class="ghost" title="Ajouter un étage">+</button>
        </div>

        <button id="btnReset" class="ghost" style="margin-left:8px">Réinitialiser</button>
        <span id="note_instant" class="small" style="margin-left:8px">Les calculs sont instantanés.</span>
      </div>

      <div id="stagesContainer" class="stages-scroll"></div>
    </div>
    <!-- Colonne centrale : Résultats -->
    <div class="card">
      <div class="results-grid">
        <div class="metric"><div class="small" id="label_gain">Gain total</div><div id="gainTotal" class="val">— dB</div></div>
        <div class="metric"><div class="small" id="label_nf">NF total</div><div id="nfTotal" class="val">— dB</div></div>
        <div class="metric"><div class="small" id="label_op">OP1dB sortie</div><div id="op1dB_out" class="val">— dBm</div></div>
        <div class="metric"><div class="small" id="label_ip">IP1dB entrée</div><div id="ip1dB_in" class="val">— dBm</div></div>
      </div>
      <!-- Tableau récapitulatif -->
      <div class="sectionTitle" id="table_title">Tableau récapitulatif</div>
        <div class="table-wrap">
          <table id="tableStages">
            <colgroup>
              <col style="width: 40px;">   <!-- # -->
              <col style="width: 100px;">  <!-- Type -->
              <col style="width: 70px;">   <!-- Gain -->
              <col style="width: 60px;">  <!-- NF/Insertion -->
              <col style="width: 100px;">  <!-- OP1dB -->
            </colgroup>

            <thead>
              <tr>
                <th>#</th>
                <th id="col_type">Type</th>
                <th id="col_gain">G (dB)</th>
                <th id="col_nf">NF (dB)</th>
                <th id="col_op">OP1dB (dBm)</th>
              </tr>
            </thead>
    <tbody></tbody>
  </table>
</div>

      </div>
    <!-- Colonne droite : Équations et rappels -->
    <div class="card">
      <div class="sectionTitle" id="eq_title">Équations (simplifiées)</div>
      <div class="eq-block" id="eq_gain">
        <div class="eq-title">Gain total (dB)</div>
        <div class="eq-line">G<sub>tot</sub>(dB) = Σ G<sub>i</sub>(dB)</div>
        <div class="small" id="eq_gain_note">(pour un filtre utiliser G = −InsertionLoss)</div>
      </div>
      <div class="eq-block" id="eq_nf">
        <div class="eq-title">NF total (Friis)</div>
        <div class="eq-line">NF<sub>tot</sub> = 10·log<sub>10</sub>(NF<sub>1</sub><sup>lin</sup> + (NF<sub>2</sub><sup>lin</sup> − 1)/G<sub>1</sub><sup>lin</sup> + (NF<sub>3</sub><sup>lin</sup> − 1)/(G<sub>1</sub><sup>lin</sup>·G<sub>2</sub><sup>lin</sup>) + ... )</div>
        <div class="small" id="eq_nf_note">avec NF<sup>lin</sup> = 10<sup>NF(dB)/10</sup> et G<sup>lin</sup> = 10<sup>G(dB)/10</sup>.</div>
      </div>
      <div class="eq-block" id="eq_p1">
        <div class="eq-title">OP1dB combiné (approx.)</div>
        <div class="eq-line">1 / P<sub>tot</sub> = Σ<sub>i</sub> 1 / (P<sub>1,i</sub> · G<sub>after,i</sub>)</div>
        <div class="eq-line">OP1dB<sub>out</sub> (dBm) = 10·log<sub>10</sub>(P<sub>tot</sub>)</div>
        <div class="small" id="eq_p1_note">P en mW (conversion dBm→mW utilisée).</div>
      </div>
      <div class="eq-block" id="eq_ip">
        <div class="eq-title">IP1dB d'entrée</div>
        <div class="eq-line">IP1dB<sub>in</sub> = OP1dB<sub>out</sub> − G<sub>tot</sub>(dB)</div>
      </div>
      <div class="sectionTitle" id="help_title" style="margin-top: 20px;">Rappels par type</div>
      <ul style="padding-left: 16px;">
        <li><b id="help_filter"></b> : <span id="help_filter_desc"></span></li>
        <li><b id="help_lna"></b> : <span id="help_lna_desc"></span></li>
        <li><b id="help_att"></b> : <span id="help_att_desc"></span></li>
        <li><b id="help_mixer"></b> : <span id="help_mixer_desc"></span></li>
      </ul>
    </div>
  </div>
  <script>
    /* ---------- i18n (simplifié, on garde fr par défaut) */
    const I18N = {
      fr: {
        types: {ampli:'LNA', filter:'Filtre', atten:'Atténuateur', switch:'Switch', mixer:'Mixer'},
        label_gain_field: 'Gain (dB) :',
        label_nf_field: 'NF (dB) :',
        label_insertion_field: 'Insertion loss (dB) :',
        label_p1: 'OP1dB (dBm) :',
        default_chain_prefix: {filter:'Filtre', lna:'LNA', mixer:'Mixer'},
        confirm_reset: 'Réinitialiser tout ?',
        details: 'Détails & trace',
        help_title: 'Rappels par type',
        help_filter: 'Filtre',
        help_filter_desc: 'renseigner Perte d’insertion (dB) et OP1dB. (NF = Perte d’insertion)',
        help_lna: 'LNA',
        help_lna_desc: 'renseigner Gain (dB), NF (dB), OP1dB.',
        help_att: 'Atténuateur / Switch',
        help_att_desc: 'renseigner Atténuation (dB) et OP1dB ; NF = Atténuation.',
        help_mixer: 'Mixer',
        help_mixer_desc: 'renseigner Perte de conversion (dB), NF (dB), OP1dB.'
      }
    };
    let currentLang = 'fr';
    function t(key){ const parts = key.split('.'); let v = I18N[currentLang]; for (const p of parts){ if (v && v[p] !== undefined) v = v[p]; else return key; } return v; }
    function applyLang(lang){ currentLang = lang; /* not used heavily here, kept for future */ }
    function applyTheme(tname){ document.body.setAttribute('data-theme', tname); }

    /* utils */
    function dbToLin(db) { if (!isFinite(db)) return 1e300; if (db > 500) return 1e300; return Math.pow(10, db / 10); }
    function linToDb(lin) { if (lin <= 0) return -Infinity; return 10 * Math.log10(lin); }

    /* DOM refs */
    const stagesContainer = document.getElementById('stagesContainer');
    const tableBody = document.querySelector('#tableStages tbody');
    const gainEl = document.getElementById('gainTotal');
    const nfEl = document.getElementById('nfTotal');
    const opOutEl = document.getElementById('op1dB_out');
    const ipInEl = document.getElementById('ip1dB_in');
    const btnReset = document.getElementById('btnReset');

   const nStagesInput = document.getElementById('nStagesInput');
    const btnAdd = document.getElementById('btnAdd');
    const btnRemove = document.getElementById('btnRemove');

    let stages = [];
    // pas besoin de remplir un select statique, l'input est éditable

    /* ========== contrôles du nombre d'étages (btn + / - / input) ========== */

// bouton + : ajouter un étage
btnAdd.addEventListener('click', () => {
  const max = 100;
  if (stages.length >= max) return;
  stages.push(defaultStage(stages.length));
  renderStages();
  computeAll();
  nStagesInput.value = stages.length;
});

// bouton - : enlever le dernier étage
btnRemove.addEventListener('click', () => {
  if (stages.length === 0) return;
  stages.pop();
  renderStages();
  computeAll();
  nStagesInput.value = stages.length;
});

// input numérique : l'utilisateur tape un nombre -> ajuste la liste
nStagesInput.addEventListener('input', (e) => {
  let v = parseInt(e.target.value, 10);
  if (Number.isNaN(v)) v = 0;
  const max = 100;
  v = Math.max(0, Math.min(max, v));
  if (v > stages.length) {
    for (let i = stages.length; i < v; i++) stages.push(defaultStage(i));
  } else if (v < stages.length) {
    stages.splice(v);
  }
  renderStages();
  computeAll();
  nStagesInput.value = v;
});

nStagesInput.addEventListener('blur', (e) => {
  let v = parseInt(e.target.value, 10);
  if (Number.isNaN(v)) v = stages.length;
  v = Math.max(0, Math.min(100, v));
  nStagesInput.value = v;
});


    function defaultStage(i){ return { name: `${t('default_chain_prefix.filter')} ${i+1}`, type: 'ampli', gain_dB: 15, nf_dB: 3, insertion_loss_dB: 1, op1db_dBm: 23 }; }

    function initialChain(){
      return [
        { name: t('default_chain_prefix.filter') + ' 1', type:'filter', gain_dB:0, nf_dB:1, insertion_loss_dB:1.0, op1db_dBm: 35 },
        { name: t('default_chain_prefix.lna') + ' 1', type:'ampli', gain_dB:20, nf_dB:1.0, insertion_loss_dB:0, op1db_dBm: 18 },
        { name: t('default_chain_prefix.filter') + ' 2', type:'filter', gain_dB:0, nf_dB:0.8, insertion_loss_dB:0.8, op1db_dBm: 38 },
        { name: t('default_chain_prefix.mixer') + ' 1', type:'mixer', gain_dB:0, nf_dB:6.0, insertion_loss_dB:6.0, op1db_dBm: 10 },
        { name: t('default_chain_prefix.filter') + ' 3', type:'filter', gain_dB:0, nf_dB:1.0, insertion_loss_dB:1.0, op1db_dBm: 40 }
      ];
    }

    function makeStageCard(idx, data) {
      const L = I18N[currentLang];
      const root = document.createElement('div');
      root.className = 'stage-card';
      root.dataset.index = idx;
      root.dataset.type = data.type;

      const header = document.createElement('div');
      header.className = 'stage-header';
      header.innerHTML = `
        <div class="stage-name">
          <input type="text" class="s_name" placeholder="Nom de l’étage…">
        </div>
        <button class="remove">X</button>
      `;


      const typeRow = document.createElement('div');
      typeRow.className = 'stage-row';
      typeRow.innerHTML = `
        <label>Type :</label>
        <select class="s_type">
          <option value="ampli">${L.types.ampli}</option>
          <option value="filter">${L.types.filter}</option>
          <option value="atten">${L.types.atten}</option>
          <option value="switch">${L.types.switch}</option>
          <option value="mixer">${L.types.mixer}</option>
        </select>
      `;
      typeRow.querySelector('.s_type').value = data.type;

      const params = document.createElement('div');
      params.className = 'stage-controls';
      params.innerHTML = `
        <div class="stage-row">
          <label class="lab_gain">${L.label_gain_field}</label>
          <input type="number" step="0.1" class="s_gain" value="${data.gain_dB}">
        </div>
        <div class="stage-row">
          <label class="lab_nf">${L.label_nf_field}</label>
          <input type="number" step="0.1" class="s_nf" value="${data.nf_dB}">
        </div>
        <div class="stage-row">
          <label class="lab_insertion">${L.label_insertion_field}</label>
          <input type="number" step="0.1" class="s_insertion" value="${data.insertion_loss_dB}">
        </div>
        <div class="stage-row">
          <label>${L.label_p1}</label>
          <input type="number" step="0.01" class="s_p1" value="${data.op1db_dBm}">
        </div>
      `;

      root.appendChild(header);
      root.appendChild(typeRow);
      root.appendChild(params);

      function updateVis() {
        const type = root.querySelector('.s_type').value;
        const lab_gain = root.querySelector('.lab_gain');
        const lab_nf = root.querySelector('.lab_nf');
        const lab_ins = root.querySelector('.lab_insertion');
        const inp_gain = root.querySelector('.s_gain');
        const inp_nf = root.querySelector('.s_nf');
        const inp_ins = root.querySelector('.s_insertion');

        // reset all visible
        lab_gain.style.display = 'inline-block'; inp_gain.style.display = 'inline-block';
        lab_ins.style.display = 'inline-block'; inp_ins.style.display = 'inline-block';
        lab_nf.style.display = 'inline-block'; inp_nf.style.display = 'inline-block';

        if (type === 'filter') {
          lab_gain.style.display = 'none'; inp_gain.style.display = 'none';
          lab_ins.textContent = L.label_insertion_field;
          lab_nf.style.display = 'none'; inp_nf.style.display = 'none';
        } else if (type === 'ampli') {
          lab_gain.style.display = 'inline-block'; inp_gain.style.display = 'inline-block';
          lab_ins.style.display = 'none'; inp_ins.style.display = 'none';
          lab_nf.style.display = 'inline-block'; inp_nf.style.display = 'inline-block';
        } else if (type === 'atten' || type === 'switch') {
          lab_gain.style.display = 'none'; inp_gain.style.display = 'none';
          lab_ins.textContent = 'Atténuation (dB) :';
          lab_nf.style.display = 'none'; inp_nf.style.display = 'none';
        } else if (type === 'mixer') {
          lab_gain.style.display = 'none'; inp_gain.style.display = 'none';
          lab_ins.textContent = 'Conversion loss (dB) :';
          lab_nf.style.display = 'inline-block'; inp_nf.style.display = 'inline-block';
        }
        root.dataset.type = type;
      }

      updateVis();

      root.querySelector('.s_type').addEventListener('change', () => { updateVis(); writeBack(); computeAll(); });
      root.querySelector('.remove').addEventListener('click', () => {
        const i = parseInt(root.dataset.index, 10);
        if (!Number.isFinite(i)) return;
        stages.splice(i, 1);
        renderStages();
        computeAll();
      });

      function writeBack(){
        const i = parseInt(root.dataset.index, 10);
        if (!Number.isFinite(i)) return;
        const s = stages[i];
        s.name = root.querySelector('.s_name').value;
        s.type = root.querySelector('.s_type').value;
        s.gain_dB = parseFloat(root.querySelector('.s_gain').value) || 0;
        // if nf field hidden by type, we won't overwrite it here; computeAll will derive NF where appropriate
        const nfVal = root.querySelector('.s_nf').value;
        s.nf_dB = (nfVal !== '') ? parseFloat(nfVal) : s.nf_dB || 0;
        s.insertion_loss_dB = parseFloat(root.querySelector('.s_insertion').value) || 0;
        s.op1db_dBm = parseFloat(root.querySelector('.s_p1').value) || 1000;
        renderSummaryTable();
      }

      root.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', () => { writeBack(); computeAll(); });
      });

      return root;
    }

    function renderStages(){ stagesContainer.innerHTML=''; stages.forEach((s, idx)=>{ const card = makeStageCard(idx, s); stagesContainer.appendChild(card); }); nStagesInput.value = stages.length; renderSummaryTable(); }

    function renderSummaryTable(){ tableBody.innerHTML=''; stages.forEach((s, idx)=>{ let gainShown=0, nfShown=0; if (s.type === 'filter' || s.type === 'atten' || s.type === 'switch') { gainShown = -(s.insertion_loss_dB||0); nfShown = (s.type==='filter' || s.type==='atten' || s.type==='switch') ? (s.insertion_loss_dB||0) : (s.nf_dB||0); } else { gainShown = s.gain_dB||0; nfShown = s.nf_dB||0; } const tr = document.createElement('tr'); tr.innerHTML = `<td>${idx+1}</td><td>${s.name} (${I18N[currentLang].types[s.type]})</td><td>${gainShown.toFixed(2)}</td><td>${nfShown.toFixed(2)}</td><td>${(s.op1db_dBm||0).toFixed(2)}</td>`; tableBody.appendChild(tr); }); }

    function calcNF(chain){ if (!chain.length) return NaN; let nf_tot = chain[0].nf_lin; let g_prod = chain[0].gain_lin; for (let i=1;i<chain.length;i++){ nf_tot += (chain[i].nf_lin - 1) / g_prod; g_prod *= chain[i].gain_lin; } return linToDb(nf_tot); }

    function calcP1db(chain){ const N = chain.length; if (N===0) return -Infinity; const gain_after = new Array(N).fill(1.0); let prod = 1.0; for (let idx=N-1; idx>=0; --idx){ gain_after[idx] = prod; prod *= chain[idx].gain_lin; } let inv_sum = 0; for (let i=0;i<N;i++){ const p = chain[i].p1_lin; if (!isFinite(p) || p<=0) continue; inv_sum += 1 / (p * gain_after[i]); } if (inv_sum === 0) return Infinity; const Ptot = 1 / inv_sum; return linToDb(Ptot); }

    function computeAll(){ if (!stages.length) return; const chainForNF=[], chainForP1=[];
      stages.forEach((s,idx)=>{
        // Decide what G and NF are depending on type
        let gain_dB=0, nf_dB=0;
        if (s.type === 'filter' || s.type === 'atten' || s.type === 'switch') {
          gain_dB = -(s.insertion_loss_dB||0);
          nf_dB = s.insertion_loss_dB||0; // NF equals insertion loss for passive
        } else if (s.type === 'mixer') {
          gain_dB = -(s.insertion_loss_dB||0);
          nf_dB = s.nf_dB || Math.abs(gain_dB);
        } else { // ampli
          gain_dB = s.gain_dB||0;
          nf_dB = (s.nf_dB!==undefined && s.nf_dB!==null) ? s.nf_dB : Math.abs(gain_dB);
        }

        const op1 = (s.op1db_dBm||1000);
        const gain_lin = dbToLin(gain_dB);
        const nf_lin = dbToLin(nf_dB);
        // convert OP1dB (dBm) to mW linear
        const p1_lin = (op1>500) ? 1e300 : Math.pow(10, op1/10);

        chainForNF.push({gain_lin,nf_lin,name:s.name});
        chainForP1.push({gain_lin,p1_lin,name:s.name,op1:op1});
      });

      const gprod = chainForNF.reduce((a,c)=>a*c.gain_lin,1);
      const gainTotal_dB = linToDb(gprod);
      const nfTotal_dB = calcNF(chainForNF);
      const p1_out = calcP1db(chainForP1);
      const ip1_in = p1_out - gainTotal_dB;

      gainEl.textContent = (isFinite(gainTotal_dB)?gainTotal_dB.toFixed(2):'—') + ' dB';
      nfEl.textContent = (isFinite(nfTotal_dB)?nfTotal_dB.toFixed(2):'—') + ' dB';
      opOutEl.textContent = (isFinite(p1_out)?p1_out.toFixed(2):'—') + ' dBm';
      ipInEl.textContent = (isFinite(ip1_in)?ip1_in.toFixed(2):'—') + ' dBm';

      renderSummaryTable();
    }

    /* render help texts that were missing */
    function renderHelp() {
      const L = I18N[currentLang];
      const elHelpFilter = document.getElementById('help_filter');
      const elHelpFilterDesc = document.getElementById('help_filter_desc');
      const elHelpLna = document.getElementById('help_lna');
      const elHelpLnaDesc = document.getElementById('help_lna_desc');
      const elHelpAtt = document.getElementById('help_att');
      const elHelpAttDesc = document.getElementById('help_att_desc');
      const elHelpMixer = document.getElementById('help_mixer');
      const elHelpMixerDesc = document.getElementById('help_mixer_desc');

      if (elHelpFilter) elHelpFilter.textContent = L.help_filter;
      if (elHelpFilterDesc) elHelpFilterDesc.textContent = L.help_filter_desc;
      if (elHelpLna) elHelpLna.textContent = L.help_lna;
      if (elHelpLnaDesc) elHelpLnaDesc.textContent = L.help_lna_desc;
      if (elHelpAtt) elHelpAtt.textContent = L.help_att;
      if (elHelpAttDesc) elHelpAttDesc.textContent = L.help_att_desc;
      if (elHelpMixer) elHelpMixer.textContent = L.help_mixer;
      if (elHelpMixerDesc) elHelpMixerDesc.textContent = L.help_mixer_desc;
    }

    /* events */
    btnReset.addEventListener('click', ()=>{ if(!confirm(I18N[currentLang].confirm_reset)) return; stages = initialChain(); renderStages(); computeAll(); });

    (function init(){ applyLang('fr'); applyTheme('dark'); stages = initialChain(); renderStages(); computeAll(); renderHelp(); })();
  </script>
  <footer style="padding: 8px 12px;">
    <div id="footer_text">Document interactif — calculs instantanés pour conception de chaîne RF.</div>
    <div class="author">François Bordas — <a href="mailto:francois.bordas@etu.univ-amu.fr">francois.bordas@etu.univ-amu.fr</a></div>
  </footer>
</body>
</html>


