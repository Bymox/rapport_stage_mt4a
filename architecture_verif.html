<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RF Chain Calculator ‚Äî NF / OP1dB / Gain (instantan√©)</title>
<style>
  :root{
    --bg: #f7f8fb;
    --card-bg: #fffefc;
    --panel-border: #e6eef8;
    --text: #0f1720;
    --muted: #6b7280;
    --accent: #8fbce6;
    --accent-strong: #6aa3d6;
    --mono-bg: #fcfcff;
  }
  /* Dark theme: deep blues / black / white ‚Äî pas de gris */
  [data-theme="dark"]{
    --bg: #000000;            /* page background: black */
    --card-bg: #041426;       /* card background: deep navy */
    --panel-border: #032b4a;  /* dark blue border */
    --text: #ffffff;          /* main text: white */
    --muted: #96bfe8;         /* muted: pale blue */
    --accent: #0b3d91;        /* accent: deep cobalt */
    --accent-strong: #2b66ff; /* brighter blue for outlines */
    --mono-bg: #021025;       /* inputs/mono background */
  }

  :root{font-family:system-ui,"Segoe UI",Roboto,Helvetica,Arial}
  body{margin:14px;line-height:1.45;background:var(--bg);transition:background .18s,color .18s;color:var(--text)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{font-size:1.25rem;margin:2px 0}
  .small{font-size:0.9rem;color:var(--muted)}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:10px}
  .card{background:var(--card-bg);border:1px solid var(--panel-border);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(2,10,25,0.3)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  label{min-width:110px;color:var(--text)}
  input[type="number"], input[type="text"], select { padding:8px;border-radius:8px;border:1px solid var(--panel-border);background:var(--mono-bg);color:var(--text) }
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent-strong);border:1px solid var(--accent);} 
  .stage{border-radius:8px;padding:10px;border:1px dashed var(--panel-border);margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
  table{border-collapse:collapse;width:100%;margin-top:8px}
  th,td{border:1px solid var(--panel-border);padding:8px;text-align:center;font-size:0.95rem;background:transparent}
  th{background:transparent;font-weight:700;color:var(--muted)}
  .metric{border-radius:10px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--panel-border);min-width:150px;margin-bottom:8px}
  .val{font-weight:700;font-size:1.05rem}
  /* log: dark background in dark mode, readable white text */
  .log{white-space:pre-wrap;background:var(--mono-bg);color:var(--text);padding:8px;border-radius:8px;font-family:monospace;font-size:0.85rem; max-height:260px; overflow:auto}
  .eq-block{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--panel-border);padding:12px;border-radius:8px;margin-bottom:10px}
  .eq-line{font-family:serif;margin:6px 0;font-size:0.98rem;color:var(--text)}
  .eq-title{font-weight:700;margin-bottom:6px;color:var(--text)}
  .author{font-size:0.9rem;color:var(--muted);margin-top:6px}
  @media(max-width:980px){ .layout{grid-template-columns:1fr} }
  /* remove any leftover fixed gray colors (buttons, remove) ‚Äî use accent and red for destructive */
  .remove-btn{background:#b0232b;color:#fff}
</style>
</head>
<body data-theme="bright">

<header>
  <div>
    <h1 id="title">RF Chain Calculator ‚Äî calcul instantan√©</h1>
    <div id="subtitle" class="small">Gain / NF (Friis) / OP1dB & IP1dB ‚Äî interface interactive</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <select id="lang" title="Langue" style="padding:8px;border-radius:8px;border:1px solid var(--panel-border);background:var(--mono-bg);color:var(--text)">
      <option value="fr">FR</option>
      <option value="en">EN</option>
    </select>
    <select id="theme" title="Th√®me" style="padding:8px;border-radius:8px;border:1px solid var(--panel-border);background:var(--mono-bg);color:var(--text)">
      <option value="bright">‚òÄÔ∏è</option>
      <option value="dark">üåô</option>
    </select>
  </div>
</header>

<div class="layout">
  <div>
    <div class="card">
      <div class="controls">
        <label id="label_n">Nombre d'√©tages :</label>
        <select id="nStages"></select>
        <button id="btnAdd">Ajouter un √©tage</button>
        <button id="btnReset" class="ghost">R√©initialiser</button>
        <div style="flex:1"></div>
        <span id="note_instant" class="small">Les calculs sont faits instantan√©ment.</span>
      </div>

      <div id="stagesContainer"></div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <div class="metric"><div class="small" id="label_gain">Gain total</div><div id="gainTotal" class="val">‚Äî dB</div></div>
        <div class="metric"><div class="small" id="label_nf">NF total</div><div id="nfTotal" class="val">‚Äî dB</div></div>
        <div class="metric"><div class="small" id="label_op">OP1dB sortie</div><div id="op1dB_out" class="val">‚Äî dBm</div></div>
        <div class="metric"><div class="small" id="label_ip">IP1dB entr√©e</div><div id="ip1dB_in" class="val">‚Äî dBm</div></div>
      </div>

      <div style="margin-top:12px">
        <div class="sectionTitle" id="table_title">Tableau r√©capitulatif</div>
        <table id="tableStages">
          <thead><tr><th>#</th><th id="col_type">Type</th><th id="col_gain">Gain (dB)</th><th id="col_nf">NF / Insertion (dB)</th><th id="col_op">OP1dB (dBm)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 id="details_title" style="margin-top:12px">D√©tails & trace</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <aside>
    <div class="card">
      <div class="sectionTitle" id="eq_title">√âquations (simplifi√©es)</div>

      <div class="eq-block" id="eq_gain">
        <div class="eq-title">Gain total (dB)</div>
        <div class="eq-line">G<sub>tot</sub>(dB) = Œ£ G<sub>i</sub>(dB)</div>
        <div class="small" id="eq_gain_note">(pour un filtre utiliser G = ‚àíInsertionLoss)</div>
      </div>

      <div class="eq-block" id="eq_nf">
        <div class="eq-title">NF total (Friis)</div>
        <div class="eq-line">NF<sub>tot</sub> = 10¬∑log<sub>10</sub>(NF<sub>1</sub><sup>lin</sup> + (NF<sub>2</sub><sup>lin</sup> ‚àí 1)/G<sub>1</sub><sup>lin</sup> + (NF<sub>3</sub><sup>lin</sup> ‚àí 1)/(G<sub>1</sub><sup>lin</sup>¬∑G<sub>2</sub><sup>lin</sup>) + ... )</div>
        <div class="small" id="eq_nf_note">avec NF<sup>lin</sup> = 10<sup>NF(dB)/10</sup> et G<sup>lin</sup> = 10<sup>G(dB)/10</sup>.</div>
      </div>

      <div class="eq-block" id="eq_p1">
        <div class="eq-title">OP1dB combin√© (approx.)</div>
        <div class="eq-line">1 / P<sub>tot</sub> = Œ£<sub>i</sub> 1 / (P<sub>1,i</sub> ¬∑ G<sub>after,i</sub>)</div>
        <div class="eq-line">OP1dB<sub>out</sub> (dBm) = 10¬∑log<sub>10</sub>(P<sub>tot</sub>)</div>
        <div class="small" id="eq_p1_note">P en mW (conversion dBm‚ÜímW utilis√©e).</div>
      </div>

      <div class="eq-block" id="eq_ip">
        <div class="eq-title">IP1dB d'entr√©e</div>
        <div class="eq-line">IP1dB<sub>in</sub> = OP1dB<sub>out</sub> ‚àí G<sub>tot</sub>(dB)</div>
      </div>

      <div class="sectionTitle" id="help_title" style="margin-top:12px"></div>
      <ul style="padding-left:16px">
        <li><b id="help_filter"></b> : <span id="help_filter_desc"></span></li>
        <li><b id="help_lna"></b> : <span id="help_lna_desc"></span></li>
        <li><b id="help_att"></b> : <span id="help_att_desc"></span></li>
        <li><b id="help_mixer"></b> : <span id="help_mixer_desc"></span></li>
      </ul>




      <div class="author" id="footer_author">Auteur : Fran√ßois Bordas ‚Äî <a href="mailto:francois.bordas@etu.univ-amu.fr">francois.bordas@etu.univ-amu.fr</a></div>
    </div>
  </aside>
</div>

<script>
/* ---------- full i18n */
const I18N = {
  fr: {
    /* En-t√™te / commandes */
    title: 'RF Chain Calculator ‚Äî calcul instantan√©',
    subtitle: 'Gain / NF (Friis) / OP1dB & IP1dB ‚Äî interface interactive',
    n_label: 'Nombre d\'√©tages :',
    add_btn: 'Ajouter un √©tage',
    reset_btn: 'R√©initialiser',
    instant_note: 'Les calculs sont faits instantan√©ment.',

    /* R√©sum√© / tableau */
    table_title: 'Tableau r√©capitulatif',
    col_type: 'Type',
    col_gain: 'Gain (dB)',
    col_nf: 'NF / Insertion (dB)',
    col_op: 'OP1dB (dBm)',
    details: 'D√©tails & trace',

    // ---- ajouter DANS I18N.fr ----
    eq_gain_title: 'Gain total (dB)',
    eq_gain_line: 'G<sub>tot</sub>(dB) = Œ£ G<sub>i</sub>(dB)',
    eq_gain_note: '(pour un filtre, utiliser G = ‚àíPerte d‚Äôinsertion)',
    eq_nf_title: 'NF totale (Friis)',
    eq_nf_line: 'NF<sub>tot</sub> = 10¬∑log<sub>10</sub>( NF<sub>1</sub><sup>lin</sup> + (NF<sub>2</sub><sup>lin</sup> ‚àí 1)/G<sub>1</sub><sup>lin</sup> + (NF<sub>3</sub><sup>lin</sup> ‚àí 1)/(G<sub>1</sub><sup>lin</sup>¬∑G<sub>2</sub><sup>lin</sup>) + ‚Ä¶ )',
    eq_nf_note: 'avec NF<sup>lin</sup> = 10<sup>NF(dB)/10</sup> et G<sup>lin</sup> = 10<sup>G(dB)/10</sup>.',
    eq_p1_title: 'OP1dB combin√© (approx.)',
    eq_p1_line1: '1 / P<sub>tot</sub> = Œ£<sub>i</sub> 1 / (P<sub>1,i</sub> ¬∑ G<sub>apr√®s,i</sub>)',
    eq_p1_line2: 'OP1dB<sub>sortie</sub> (dBm) = 10¬∑log<sub>10</sub>(P<sub>tot</sub>)',
    eq_p1_note: 'P en mW (conversion dBm‚ÜímW).',
    eq_ip_title: 'IP1dB d‚Äôentr√©e',
    eq_ip_line: 'IP1dB<sub>entr√©e</sub> = OP1dB<sub>sortie</sub> ‚àí G<sub>tot</sub>(dB)',

    // help descriptions (les noms en _desc sont utilis√©s par applyLang)
    help_filter_desc: 'renseigner Perte d‚Äôinsertion (dB) et OP1dB. (NF = Perte d‚Äôinsertion)',
    help_lna_desc: 'renseigner Gain (dB), NF (dB), OP1dB.',
    help_att_desc: 'renseigner Att√©nuation (dB) et OP1dB ; NF = Att√©nuation.',
    help_mixer_desc: 'renseigner Perte de conversion (dB), NF (dB), OP1dB.',

    /* √âquations */
    eq_title: '√âquations (simplifi√©es)',
    eq_gain_title: 'Gain total (dB)',
    eq_gain_line: 'G<sub>tot</sub>(dB) = Œ£ G<sub>i</sub>(dB)',
    eq_gain_note: '(pour un filtre, utiliser G = ‚àíPerte d‚Äôinsertion)',
    eq_nf_title: 'NF totale (Friis)',
    eq_nf_line: 'NF<sub>tot</sub> = 10¬∑log<sub>10</sub>( NF<sub>1</sub><sup>lin</sup> + (NF<sub>2</sub><sup>lin</sup> ‚àí 1)/G<sub>1</sub><sup>lin</sup> + (NF<sub>3</sub><sup>lin</sup> ‚àí 1)/(G<sub>1</sub><sup>lin</sup>¬∑G<sub>2</sub><sup>lin</sup>) + ‚Ä¶ )',
    eq_nf_note: 'avec NF<sup>lin</sup> = 10<sup>NF(dB)/10</sup> et G<sup>lin</sup> = 10<sup>G(dB)/10</sup>.',
    eq_p1_title: 'OP1dB combin√© (approx.)',
    eq_p1_line1: '1 / P<sub>tot</sub> = Œ£<sub>i</sub> 1 / (P<sub>1,i</sub> ¬∑ G<sub>apr√®s,i</sub>)',
    eq_p1_line2: 'OP1dB<sub>sortie</sub> (dBm) = 10¬∑log<sub>10</sub>(P<sub>tot</sub>)',
    eq_p1_note: 'P en mW (conversion dBm‚ÜímW).',
    eq_ip_title: 'IP1dB d‚Äôentr√©e',
    eq_ip_line: 'IP1dB<sub>entr√©e</sub> = OP1dB<sub>sortie</sub> ‚àí G<sub>tot</sub>(dB)',

    /* Aide par type */
    help_title: 'Rappels par type',
    help_filter: 'Filtre',
    help_filter_desc: 'renseigner Perte d‚Äôinsertion (dB) et OP1dB. (NF = Perte d‚Äôinsertion)',
    help_lna: 'LNA',
    help_lna_desc: 'renseigner Gain (dB), NF (dB), OP1dB.',
    help_att: 'Att√©nuateur / Switch',
    help_att_desc: 'renseigner Att√©nuation (dB) et OP1dB ; NF = Att√©nuation.',
    help_mixer: 'Mixer',
    help_mixer_desc: 'renseigner Perte de conversion (dB), NF (dB), OP1dB.',

    /* Types / labels / divers */
    types: {ampli:'LNA', filter:'Filtre', atten:'Att√©nuateur', switch:'Switch', mixer:'Mixer'},
    label_gain: 'Gain total',
    label_nf: 'NF total',
    label_op: 'OP1dB sortie',
    label_ip: 'IP1dB entr√©e',
    label_gain_field: 'Gain (dB) :',
    label_nf_field: 'NF (dB) :',
    label_insertion_field: 'Insertion/Att√©n (dB) :',
    label_p1: 'OP1dB (dBm) :',
    confirm_reset: 'R√©initialiser tout ?',
    log_line: '#{i} {name}({type}) ‚Äî gain {g} dB, NF {nf} dB, OP1dB {p} dBm',
    default_chain_prefix: {filter:'Filtre', lna:'LNA', mixer:'Mixer'},
    footer: 'Document interactif ‚Äî calculs instantan√©s pour conception de cha√Æne RF.'
  },

  en: {
    /* Header / controls */
    title: 'RF Chain Calculator ‚Äî live compute',
    subtitle: 'Gain / NF (Friis) / OP1dB & IP1dB ‚Äî interactive UI',
    n_label: 'Number of stages:',
    add_btn: 'Add stage',
    reset_btn: 'Reset',
    instant_note: 'Calculations are done instantly.',

    /* Summary / table */
    table_title: 'Summary table',
    col_type: 'Type',
    col_gain: 'Gain (dB)',
    col_nf: 'NF / Insertion (dB)',
    col_op: 'OP1dB (dBm)',
    details: 'Details & trace',

    // ---- ajouter DANS I18N.en ----
    eq_gain_title: 'Total gain (dB)',
    eq_gain_line: 'G<sub>tot</sub>(dB) = Œ£ G<sub>i</sub>(dB)',
    eq_gain_note: '(for a filter, use G = ‚àíInsertion loss)',
    eq_nf_title: 'Total NF (Friis)',
    eq_nf_line: 'NF<sub>tot</sub> = 10¬∑log<sub>10</sub>( NF<sub>1</sub><sup>lin</sup> + (NF<sub>2</sub><sup>lin</sup> ‚àí 1)/G<sub>1</sub><sup>lin</sup> + (NF<sub>3</sub><sup>lin</sup> ‚àí 1)/(G<sub>1</sub><sup>lin</sup>¬∑G<sub>2</sub><sup>lin</sup>) + ‚Ä¶ )',
    eq_nf_note: 'with NF<sup>lin</sup> = 10<sup>NF(dB)/10</sup> and G<sup>lin</sup> = 10<sup>G(dB)/10</sup>.',
    eq_p1_title: 'Combined OP1dB (approx.)',
    eq_p1_line1: '1 / P<sub>tot</sub> = Œ£<sub>i</sub> 1 / (P<sub>1,i</sub> ¬∑ G<sub>after,i</sub>)',
    eq_p1_line2: 'OP1dB<sub>out</sub> (dBm) = 10¬∑log<sub>10</sub>(P<sub>tot</sub>)',
    eq_p1_note: 'P in mW (dBm‚ÜímW conversion).',
    eq_ip_title: 'Input IP1dB',
    eq_ip_line: 'IP1dB<sub>in</sub> = OP1dB<sub>out</sub> ‚àí G<sub>tot</sub>(dB)',

    // help descriptions
    help_filter_desc: 'fill in Insertion loss (dB) and OP1dB. (NF = Insertion loss)',
    help_lna_desc: 'fill in Gain (dB), NF (dB), OP1dB.',
    help_att_desc: 'fill in Attenuation (dB) and OP1dB; NF = Attenuation.',
    help_mixer_desc: 'fill in Conversion loss (dB), NF (dB), OP1dB.',

    /* Equations */
    eq_title: 'Equations (simplified)',
    eq_gain_title: 'Total gain (dB)',
    eq_gain_line: 'G<sub>tot</sub>(dB) = Œ£ G<sub>i</sub>(dB)',
    eq_gain_note: '(for a filter, use G = ‚àíInsertion loss)',
    eq_nf_title: 'Total NF (Friis)',
    eq_nf_line: 'NF<sub>tot</sub> = 10¬∑log<sub>10</sub>( NF<sub>1</sub><sup>lin</sup> + (NF<sub>2</sub><sup>lin</sup> ‚àí 1)/G<sub>1</sub><sup>lin</sup> + (NF<sub>3</sub><sup>lin</sup> ‚àí 1)/(G<sub>1</sub><sup>lin</sup>¬∑G<sub>2</sub><sup>lin</sup>) + ‚Ä¶ )',
    eq_nf_note: 'with NF<sup>lin</sup> = 10<sup>NF(dB)/10</sup> and G<sup>lin</sup> = 10<sup>G(dB)/10</sup>.',
    eq_p1_title: 'Combined OP1dB (approx.)',
    eq_p1_line1: '1 / P<sub>tot</sub> = Œ£<sub>i</sub> 1 / (P<sub>1,i</sub> ¬∑ G<sub>after,i</sub>)',
    eq_p1_line2: 'OP1dB<sub>out</sub> (dBm) = 10¬∑log<sub>10</sub>(P<sub>tot</sub>)',
    eq_p1_note: 'P in mW (dBm‚ÜímW conversion).',
    eq_ip_title: 'Input IP1dB',
    eq_ip_line: 'IP1dB<sub>in</sub> = OP1dB<sub>out</sub> ‚àí G<sub>tot</sub>(dB)',

    /* Help by type */
    help_title: 'Notes by type',
    help_filter: 'Filter',
    help_filter_desc: 'fill in Insertion loss (dB) and OP1dB. (NF = Insertion loss)',
    help_lna: 'LNA',
    help_lna_desc: 'fill in Gain (dB), NF (dB), OP1dB.',
    help_att: 'Attenuator / Switch',
    help_att_desc: 'fill in Attenuation (dB) and OP1dB; NF = Attenuation.',
    help_mixer: 'Mixer',
    help_mixer_desc: 'fill in Conversion loss (dB), NF (dB), OP1dB.',

    /* Types / labels / misc */
    types: {ampli:'LNA', filter:'Filter', atten:'Attenuator', switch:'Switch', mixer:'Mixer'},
    label_gain: 'Total gain',
    label_nf: 'Total NF',
    label_op: 'OP1dB out',
    label_ip: 'IP1dB in',
    label_gain_field: 'Gain (dB) :',
    label_nf_field: 'NF (dB) :',
    label_insertion_field: 'Insertion/Attn (dB) :',
    label_p1: 'OP1dB (dBm) :',
    confirm_reset: 'Reset everything?',
    log_line: '#{i} {name}({type}) ‚Äî gain {g} dB, NF {nf} dB, OP1dB {p} dBm',
    default_chain_prefix: {filter:'Filter', lna:'LNA', mixer:'Mixer'},
    footer: 'Interactive document ‚Äî live computations for RF chain design.'
  }
};

let currentLang = 'fr';
function t(key){ const parts = key.split('.'); let v = I18N[currentLang]; for (const p of parts){ if (v && v[p] !== undefined) v = v[p]; else return key; } return v; }
function applyLang(lang) {
  currentLang = lang;
  const dict = I18N[lang] || I18N.fr;

  // Titres / textes principaux
  document.getElementById('title').textContent = dict.title;
  document.getElementById('subtitle').textContent = dict.subtitle;
  document.getElementById('label_n').textContent = dict.n_label;
  document.getElementById('btnAdd').textContent = dict.add_btn;
  document.getElementById('btnReset').textContent = dict.reset_btn;
  document.getElementById('note_instant').textContent = dict.instant_note;
  document.getElementById('table_title').textContent = dict.table_title;
  document.getElementById('col_type').textContent = dict.col_type;
  document.getElementById('col_gain').textContent = dict.col_gain;
  document.getElementById('col_nf').textContent = dict.col_nf;
  document.getElementById('col_op').textContent = dict.col_op;
  document.getElementById('details_title').textContent = dict.details;
  document.getElementById('eq_title').textContent = dict.eq_title;

  // --- Equations : mettre √† jour titres / lignes / notes ----
  // eq_gain
  const eg = document.getElementById('eq_gain');
  if (eg) {
    const t = eg.querySelector('.eq-title'); if (t) t.innerHTML = dict.eq_gain_title || '';
    const l = eg.querySelector('.eq-line'); if (l) l.innerHTML = dict.eq_gain_line || '';
    const n = document.getElementById('eq_gain_note'); if (n) n.innerHTML = dict.eq_gain_note || '';
  }

  // eq_nf
  const enf = document.getElementById('eq_nf');
  if (enf) {
    const t = enf.querySelector('.eq-title'); if (t) t.innerHTML = dict.eq_nf_title || '';
    const l = enf.querySelector('.eq-line'); if (l) l.innerHTML = dict.eq_nf_line || '';
    const n = document.getElementById('eq_nf_note'); if (n) n.innerHTML = dict.eq_nf_note || '';
  }

  // eq_p1 (2 lignes)
  const ep1 = document.getElementById('eq_p1');
  if (ep1) {
    const t = ep1.querySelector('.eq-title'); if (t) t.innerHTML = dict.eq_p1_title || '';
    const lines = ep1.querySelectorAll('.eq-line');
    if (lines && lines.length > 0) {
      lines[0].innerHTML = dict.eq_p1_line1 || '';
      if (lines.length > 1) lines[1].innerHTML = dict.eq_p1_line2 || '';
    }
    const n = document.getElementById('eq_p1_note'); if (n) n.innerHTML = dict.eq_p1_note || '';
  }

  // eq_ip
  const eip = document.getElementById('eq_ip');
  if (eip) {
    const t = eip.querySelector('.eq-title'); if (t) t.innerHTML = dict.eq_ip_title || '';
    const l = eip.querySelector('.eq-line'); if (l) l.innerHTML = dict.eq_ip_line || '';
  }

  // Help section (titres et descriptions compl√®tes) ‚Äî utilise les cl√©s *_desc
  document.getElementById('help_title').textContent = dict.help_title;
  document.getElementById('help_filter').textContent = dict.help_filter;
  const hf = document.getElementById('help_filter_desc'); if (hf) hf.innerHTML = dict.help_filter_desc || dict.help_filter_txt || '';
  document.getElementById('help_lna').textContent = dict.help_lna;
  const hl = document.getElementById('help_lna_desc'); if (hl) hl.innerHTML = dict.help_lna_desc || dict.help_lna_txt || '';
  document.getElementById('help_att').textContent = dict.help_att;
  const ha = document.getElementById('help_att_desc'); if (ha) ha.innerHTML = dict.help_att_desc || dict.help_att_txt || '';
  document.getElementById('help_mixer').textContent = dict.help_mixer;
  const hm = document.getElementById('help_mixer_desc'); if (hm) hm.innerHTML = dict.help_mixer_desc || dict.help_mixer_txt || '';

  // R√©sultats
  document.getElementById('label_gain').textContent = dict.label_gain;
  document.getElementById('label_nf').textContent = dict.label_nf;
  document.getElementById('label_op').textContent = dict.label_op;
  document.getElementById('label_ip').textContent = dict.label_ip;

  // Footer auteur
  document.getElementById('footer_author').innerHTML =
    (lang === 'fr')
      ? 'Auteur : Fran√ßois Bordas ‚Äî <a href="mailto:francois.bordas@etu.univ-amu.fr">francois.bordas@etu.univ-amu.fr</a>'
      : 'Author: Fran√ßois Bordas ‚Äî <a href="mailto:francois.bordas@etu.univ-amu.fr">francois.bordas@etu.univ-amu.fr</a>';

  // Re-render
  renderStages();
  computeAll();
  if (document.querySelector('footer div')) {
    document.querySelector('footer div').textContent = dict.footer;
  }
}


function applyTheme(tname){ document.body.setAttribute('data-theme', tname); }

/* utils */
function dbToLin(db) { if (!isFinite(db)) return 1e300; if (db > 500) return 1e300; return Math.pow(10, db / 10); }
function linToDb(lin) { if (lin <= 0) return -Infinity; return 10 * Math.log10(lin); }

/* DOM refs */
const selectN = document.getElementById('nStages');
const stagesContainer = document.getElementById('stagesContainer');
const tableBody = document.querySelector('#tableStages tbody');
const logEl = document.getElementById('log');
const gainEl = document.getElementById('gainTotal');
const nfEl = document.getElementById('nfTotal');
const opOutEl = document.getElementById('op1dB_out');
const ipInEl = document.getElementById('ip1dB_in');
const btnAdd = document.getElementById('btnAdd');
const btnReset = document.getElementById('btnReset');
let stages = [];

for (let i=1;i<=30;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; selectN.appendChild(o); }

function defaultStage(i){ return { name: `${t('default_chain_prefix.filter')} ${i+1}`, type: 'ampli', gain_dB: 15, nf_dB: 3, insertion_loss_dB: 1, op1db_dBm: 23 }; }

function initialChain(){
  return [
    { name: t('default_chain_prefix.filter') + ' 1', type:'filter', gain_dB:0, nf_dB:1, insertion_loss_dB:1.0, op1db_dBm: 35 },
    { name: t('default_chain_prefix.lna') + ' 1', type:'ampli', gain_dB:20, nf_dB:1.0, insertion_loss_dB:0, op1db_dBm: 18 },
    { name: t('default_chain_prefix.filter') + ' 2', type:'filter', gain_dB:0, nf_dB:0.8, insertion_loss_dB:0.8, op1db_dBm: 38 },
    { name: t('default_chain_prefix.mixer') + ' 1', type:'mixer', gain_dB:0, nf_dB:6.0, insertion_loss_dB:6.0, op1db_dBm: 10 },
    { name: t('default_chain_prefix.filter') + ' 3', type:'filter', gain_dB:0, nf_dB:1.0, insertion_loss_dB:1.0, op1db_dBm: 40 }
  ];
}

function makeStageCard(idx, data){
  const L = I18N[currentLang];
  const root = document.createElement('div'); root.className='stage'; root.dataset.index = idx;
  const r1 = document.createElement('div'); r1.className='row';
  r1.innerHTML = `
    <label><b>${currentLang==='fr' ? '√âtage' : 'Stage'} ${idx+1}</b></label>
    <input type="text" class="s_name" value="${data.name}" style="width:150px">
    <label style="min-width:60px">${currentLang==='fr' ? 'Type' : 'Type'} :</label>
    <select class="s_type"></select>
    <button class="remove" style="margin-left:auto;background:#b0232b;color:#fff;padding:6px;border-radius:6px;border:0">${currentLang==='fr' ? 'Suppr' : 'Remove'}</button>
  `;
  root.appendChild(r1);
  const params = document.createElement('div');
  params.innerHTML = `
    <div class="row">
      <label class="lab_gain">${L.label_gain_field}</label>
      <input type="number" step="0.1" class="s_gain" value="${data.gain_dB}" style="width:100px">
      <label class="lab_nf">${L.label_nf_field}</label>
      <input type="number" step="0.1" class="s_nf" value="${data.nf_dB}" style="width:100px">
      <label class="lab_insertion">${L.label_insertion_field}</label>
      <input type="number" step="0.1" class="s_insertion" value="${data.insertion_loss_dB}" style="width:100px">
    </div>
    <div class="row">
      <label>${L.label_p1}</label>
      <input type="number" step="0.01" class="s_p1" value="${data.op1db_dBm}" style="width:120px">
      <div class="small" style="margin-left:8px;color:var(--muted)">${currentLang==='fr' ? 'Remplir selon type' : 'Fill according to type'}</div>
    </div>
  `;
  root.appendChild(params);

  const sel = root.querySelector('.s_type');
  const types = ['ampli','filter','atten','switch','mixer'];
  types.forEach(tp => { const o = document.createElement('option'); o.value = tp; o.textContent = L.types[tp]; sel.appendChild(o); });
  sel.value = data.type;

  function updateVis(){
    const t = sel.value;
    const lab_gain = root.querySelector('.lab_gain'); const lab_nf = root.querySelector('.lab_nf'); const lab_ins = root.querySelector('.lab_insertion');
    const inp_gain = root.querySelector('.s_gain'); const inp_nf = root.querySelector('.s_nf'); const inp_ins = root.querySelector('.s_insertion');
    lab_gain.style.display = 'inline-block'; inp_gain.style.display = 'inline-block'; lab_nf.style.display = 'inline-block'; inp_nf.style.display = 'inline-block'; lab_ins.style.display = 'inline-block'; inp_ins.style.display = 'inline-block';
    if (t === 'filter') { lab_gain.style.display='none'; inp_gain.style.display='none'; lab_ins.textContent = currentLang==='fr' ? 'Insertion (dB) :' : 'Insertion loss (dB) :'; lab_nf.style.display='none'; inp_nf.style.display='none'; }
    else if (t === 'ampli') { lab_gain.textContent = currentLang==='fr' ? 'Gain (dB) :' : 'Gain (dB) :'; lab_ins.style.display='none'; inp_ins.style.display='none'; lab_nf.style.display='inline-block'; inp_nf.style.display='inline-block'; }
    else if (t === 'atten') { lab_gain.style.display='none'; inp_gain.style.display='none'; lab_ins.textContent = currentLang==='fr' ? 'Att√©nuation (dB) :' : 'Attenuation (dB) :'; lab_nf.style.display='none'; inp_nf.style.display='none'; }
    else if (t === 'switch') { lab_gain.style.display='none'; inp_gain.style.display='none'; lab_ins.textContent = currentLang==='fr' ? 'Att√©nuation (dB) :' : 'Attenuation (dB) :'; lab_nf.style.display='none'; inp_nf.style.display='none'; }
    else if (t === 'mixer') { lab_gain.style.display='none'; inp_gain.style.display='none'; lab_ins.textContent = currentLang==='fr' ? 'Conversion loss (dB) :' : 'Conversion loss (dB) :'; lab_nf.style.display='inline-block'; inp_nf.style.display='inline-block'; }
  }
  updateVis();

  root.querySelector('.remove').addEventListener('click', ()=>{ const i = parseInt(root.dataset.index,10); stages.splice(i,1); renderStages(); computeAll(); });

  function writeBack(){ const i = parseInt(root.dataset.index,10); const s = stages[i]; s.name = root.querySelector('.s_name').value; s.type = root.querySelector('.s_type').value; s.gain_dB = parseFloat(root.querySelector('.s_gain').value) || 0; s.nf_dB = parseFloat(root.querySelector('.s_nf').value) || Math.abs(s.gain_dB || 0); s.insertion_loss_dB = parseFloat(root.querySelector('.s_insertion').value) || 0; s.op1db_dBm = parseFloat(root.querySelector('.s_p1').value) || 1000; renderSummaryTable(); computeAll(); }

  root.querySelectorAll('input,select').forEach(el=>{ el.addEventListener('input', ()=>{ if (el.classList.contains('s_type')) updateVis(); writeBack(); }); });
  return root;
}

function renderStages(){ stagesContainer.innerHTML=''; stages.forEach((s, idx)=>{ const card = makeStageCard(idx, s); stagesContainer.appendChild(card); }); selectN.value = stages.length; renderSummaryTable(); }

function renderSummaryTable(){ tableBody.innerHTML=''; stages.forEach((s, idx)=>{ let gainShown=0, nfShown=0; if (s.type === 'filter' || s.type === 'atten' || s.type === 'switch' || s.type === 'mixer') { gainShown = -(s.insertion_loss_dB||0); nfShown = (s.type==='filter' || s.type==='atten' || s.type==='switch') ? (s.insertion_loss_dB||0) : (s.nf_dB||0); } else { gainShown = s.gain_dB||0; nfShown = s.nf_dB||0; } const tr = document.createElement('tr'); tr.innerHTML = `<td>${idx+1}</td><td>${s.name} (${I18N[currentLang].types[s.type]})</td><td>${gainShown.toFixed(2)}</td><td>${nfShown.toFixed(2)}</td><td>${(s.op1db_dBm||0).toFixed(2)}</td>`; tableBody.appendChild(tr); }); }

function calcNF(chain){ if (!chain.length) return NaN; let nf_tot = chain[0].nf_lin; let g_prod = chain[0].gain_lin; for (let i=1;i<chain.length;i++){ nf_tot += (chain[i].nf_lin - 1) / g_prod; g_prod *= chain[i].gain_lin; } return linToDb(nf_tot); }
function calcP1db(chain){ const N = chain.length; if (N===0) return -Infinity; const gain_after = new Array(N).fill(1.0); let prod = 1.0; for (let idx=N-1; idx>=0; --idx){ gain_after[idx] = prod; prod *= chain[idx].gain_lin; } let inv_sum = 0; for (let i=0;i<N;i++){ const p = chain[i].p1_lin; if (!isFinite(p) || p<=0) continue; inv_sum += 1 / (p * gain_after[i]); } if (inv_sum === 0) return Infinity; const Ptot = 1 / inv_sum; return linToDb(Ptot); }

function computeAll(){ if (!stages.length) return; const chainForNF=[], chainForP1=[], logs=[]; stages.forEach((s,idx)=>{ let gain_dB=0, nf_dB=0; if (s.type === 'filter' || s.type === 'atten' || s.type === 'switch' || s.type==='mixer') { gain_dB = -(s.insertion_loss_dB||0); if (s.type === 'mixer') nf_dB = s.nf_dB||0; else nf_dB = s.insertion_loss_dB||0; } else { gain_dB = s.gain_dB||0; nf_dB = s.nf_dB||Math.abs(gain_dB); } const op1 = (s.op1db_dBm||1000); const gain_lin = dbToLin(gain_dB); const nf_lin = dbToLin(nf_dB); const p1_lin = (op1>500) ? 1e300 : dbToLin(op1); chainForNF.push({gain_lin,nf_lin,name:s.name}); chainForP1.push({gain_lin,p1_lin,name:s.name,op1:op1}); const logTpl = I18N[currentLang].log_line; const line = logTpl.replace('{i}', `#${idx+1}`).replace('{name}', s.name).replace('{type}', I18N[currentLang].types[s.type]).replace('{g}', gain_dB.toFixed(2)).replace('{nf}', nf_dB.toFixed(2)).replace('{p}', op1.toFixed(2)); logs.push(line); }); const gprod = chainForNF.reduce((a,c)=>a*c.gain_lin,1); const gainTotal_dB = linToDb(gprod); const nfTotal_dB = calcNF(chainForNF); const p1_out = calcP1db(chainForP1); const ip1_in = p1_out - gainTotal_dB; gainEl.textContent = (isFinite(gainTotal_dB)?gainTotal_dB.toFixed(2):'‚Äî') + ' dB'; nfEl.textContent = (isFinite(nfTotal_dB)?nfTotal_dB.toFixed(2):'‚Äî') + ' dB'; opOutEl.textContent = (isFinite(p1_out)?p1_out.toFixed(2):'‚Äî') + ' dBm'; ipInEl.textContent = (isFinite(ip1_in)?ip1_in.toFixed(2):'‚Äî') + ' dBm'; const lines = [I18N[currentLang].details + ' ---', ...logs, '', `${currentLang==='fr'?'Gain total (dB)':'Total gain (dB)'} = ${gainTotal_dB.toFixed(3)}`, `${currentLang==='fr'?'NF total (dB, Friis)':'Total NF (dB, Friis)'} = ${nfTotal_dB.toFixed(3)}`, `${currentLang==='fr'?'OP1dB sortie (dBm)':'OP1dB out (dBm)'} = ${p1_out.toFixed(3)}`, `${currentLang==='fr'?'IP1dB entr√©e (dBm)':'IP1dB in (dBm)'} = ${ip1_in.toFixed(3)}`]; logEl.textContent = lines.join(''); renderSummaryTable(); }

/* events */
selectN.addEventListener('change', ()=>{ const n = parseInt(selectN.value,10); if (n > stages.length){ for (let i=stages.length;i<n;i++) stages.push(defaultStage(i)); } else if (n < stages.length){ stages.splice(n); } renderStages(); computeAll(); });
btnAdd.addEventListener('click', ()=>{ stages.push(defaultStage(stages.length)); renderStages(); computeAll(); });
btnReset.addEventListener('click', ()=>{ if(!confirm(I18N[currentLang].confirm_reset)) return; stages = initialChain(); renderStages(); computeAll(); });

document.getElementById('lang').addEventListener('change',(e)=>{ applyLang(e.target.value); });
document.getElementById('theme').addEventListener('change',(e)=>{ applyTheme(e.target.value); });

(function init(){ applyLang('fr'); applyTheme('bright'); stages = initialChain(); renderStages(); computeAll(); })();
</script>

<footer style="padding:8px 12px">
  <div id="footer_text">Document interactif ‚Äî calculs instantan√©s pour conception de cha√Æne RF.</div>
  <div class="author">Fran√ßois Bordas ‚Äî <a href="mailto:francois.bordas@etu.univ-amu.fr">francois.bordas@etu.univ-amu.fr</a></div>
</footer>
</body>
</html>
