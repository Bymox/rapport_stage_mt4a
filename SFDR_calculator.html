<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculateur SFDR / MDS — instantané</title>
<style>
:root{
  --bg:#071026; --card:#081428; --panel:#0f2b3a; --muted:#9aa3b2; --text:#e6eef6;
  --accent:#4aa3e0; --accent-2:#7ad3b7; --mono:#06101a; --glass: rgba(255,255,255,0.03);
  --success:#7ad3b7; --danger:#e06b6b;
}
*{box-sizing:border-box}
body{
  margin:0;padding:18px;font-family:Inter, "Segoe UI", Roboto, system-ui, sans-serif;
  background:linear-gradient(180deg,#031023 0%, #071026 60%); color:var(--text);
}
.container{max-width:980px;margin:12px auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
.header{display:flex;flex-direction:column;gap:6px;margin-bottom:4px}
h1{margin:0;font-size:1.25rem;color:var(--accent)}
.small{color:var(--muted);font-size:0.9rem}
.card{background:var(--card);border:1px solid var(--panel);border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(3,10,18,0.6)}
.form-row{display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:center;margin-bottom:10px}
.form-row .full{grid-column:1/-1}
label{font-size:0.92rem;color:var(--muted);display:block;margin-bottom:6px}
input[type="number"], input[type="text"], select{
  width:100%;padding:8px;border-radius:8px;border:1px solid var(--panel);background:var(--mono);color:var(--text);
  font-size:0.95rem;
}
.row-inline{display:flex;gap:8px;align-items:center}
.small-muted{font-size:0.8rem;color:var(--muted)}
.result{display:flex;flex-direction:column;gap:8px}
.metric{background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06));padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
.metric h3{margin:0;font-size:0.88rem;color:var(--muted)}
.metric .val{font-weight:700;font-size:1.1rem;color:var(--accent-2)}
.form-actions{display:flex;gap:8px;align-items:center;margin-top:6px}
.btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--accent);color:var(--accent)}
.notice{padding:8px;border-radius:8px;background:rgba(122,211,183,0.06);border:1px solid rgba(122,211,183,0.06);color:var(--muted);font-size:0.9rem}
.eq{font-family:ui-monospace, SFMono-Regular, Menlo, "Roboto Mono", monospace;background:var(--mono);padding:10px;border-radius:8px;border:1px solid var(--panel);color:var(--text);white-space:pre-wrap}
.footer{grid-column:1/-1;margin-top:8px;color:var(--muted);font-size:0.85rem;text-align:center}
@media (max-width:980px){ .container{grid-template-columns:1fr} .form-row{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>Calculateur SFDR & MDS — instantané</h1>
        <div class="small">Entrez les paramètres ci-dessous — tous les calculs se mettent à jour automatiquement.</div>
      </div>

      <!-- Formulaire principal -->
      <div id="form">
        <div class="form-row">
          <div>
            <label for="bw">Bande passante (Hz)</label>
            <input id="bw" type="number" step="1" value="1000000" />
            <div class="small-muted">Ex : 1e6 pour 1 MHz.</div>
          </div>
          <div>
            <label for="temp">Température (°C)</label>
            <input id="temp" type="number" step="0.1" value="20.0" />
            <div class="small-muted">Convertie en Kelvin (T[K]=T[°C]+273.15)</div>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label for="gain">Gain total (dB)</label>
            <input id="gain" type="number" step="0.1" value="30" />
            <div class="small-muted">Utilisé si l'IP1 donné est OP1dB (sortie).</div>
          </div>
          <div>
            <label for="nf">NF (dB)</label>
            <input id="nf" type="number" step="0.01" value="3.0" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Choix : entrer IP1dB (ou OP1dB) <em>ou</em> IIP3 directement</label>
            <div class="row-inline">
              <label class="small-muted"><input type="radio" name="mode" value="ip1" checked/> IP1 / OP1</label>
              <label class="small-muted"><input type="radio" name="mode" value="iip3"/> IIP3 direct</label>
            </div>
          </div>
          <div>
            <label for="ip1">IP1dB (dBm)</label>
            <input id="ip1" type="number" step="0.01" value="18.00" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label class="small-muted"><input id="ip1_is_output" type="checkbox"/> IP1 fourni est OP1dB (sortie) — convertir en entrée via le gain</label>
          </div>
          <div>
            <label for="delta">Δ pour IIP3 = IP1 + Δ (dB)</label>
            <input id="delta" type="number" step="0.1" value="10.0" />
            <div class="small-muted">Si vous connaissez IIP3, choisissez le mode IIP3 direct.</div>
          </div>
        </div>

        <div id="iip3row" class="form-row full" style="display:none">
          <div>
            <label for="iip3">IIP3 direct (dBm)</label>
            <input id="iip3" type="number" step="0.01" value="28.00" />
            <div class="small-muted">Saisissez IIP3 directement (si connu).</div>
          </div>
        </div>

        <div class="form-actions">
          <div class="notice">Formules utilisées : <strong>MDS(dBm) = 10·log10(k·T·BW) + 30 + NF</strong><br>et <strong>SFDR(dB) = (2/3)·(IIP3 − MDS)</strong>.</div>
          <button id="resetBtn" class="btn ghost" style="margin-left:auto">Réinitialiser</button>
        </div>
      </div>

      <!-- Résultats -->
      <div style="margin-top:14px" class="result">
        <div class="metric">
          <h3>IIP3 utilisé (dBm)</h3>
          <div id="iip3_used" class="val">—</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
          <div class="metric">
            <h3>MDS (dBm) — Minimum Detectable Signal</h3>
            <div id="mds_pow" class="val">—</div>
            <div class="small-muted" id="mds_expr"></div>
          </div>
          <div class="metric">
            <h3>SFDR (dB)</h3>
            <div id="sfdr" class="val">—</div>
            <div class="small-muted">Plus grand = meilleure plage dynamique sans spurious</div>
          </div>
        </div>

        <div style="margin-top:10px" class="eq">
          <strong>Formules :</strong>
          MDS (dBm) = 10·log10(k · T[K] · BW) + 30 + NF
          SFDR (dB) = (2/3) · (IIP3 − MDS)
          k = 1.380649e-23 J/K
          T[K] = T[°C] + 273.15
          Si IP1 fourni → IIP3 ≈ IP1 + Δ (par défaut Δ = 10 dB)
          Si OP1 fourni → IP1_in = OP1_out − Gain
        </div>
      </div>

    </div>

    <!-- Colonne aide / explications -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;color:var(--accent)">Aide et explications</h3>
      <div class="small-muted" style="margin-bottom:10px">
        - Entrez la bande passante en Hz (ex : 1e6 pour 1 MHz).<br>
        - Température en °C (ex : 20 → 293.15 K).<br>
        - NF en dB (pour la chaîne ou l'étage de référence).<br>
        - IP1dB : si vous entrez OP1dB (sortie), cochez la case "IP1 fourni est OP1dB" pour que l'outil le ramène à l'entrée en soustrayant le gain.<br>
        - Δ : marge empirique pour estimer IIP3 depuis IP1. Valeur par défaut souvent utilisée : 10 dB.
      </div>

      <div style="margin-top:6px" class="metric">
        <h3>Exemple rapide</h3>
        <div class="small-muted">BW = 1 MHz, NF = 3 dB, T = 20 °C →</div>
        <div style="margin-top:6px;font-weight:700">MDS ≈ 10·log10(k·293.15·1e6)+30+3 ≈ ... puis SFDR = (2/3)·(IIP3 − MDS)</div>
      </div>

      <div style="margin-top:12px" class="metric">
        <h3>Notes</h3>
        <div class="small-muted">
          • Ici SFDR est calculé en référence à l'entrée (IIP3).<br>
          • Les formules supposent le bruit thermique (kT·BW) puis ajout du NF en dB.<br>
          • Estimation IIP3 depuis IP1 est empirique (Δ variable selon l'ampli).
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="copyBtn" class="btn">Copier les résultats</button>
        <button id="downloadBtn" class="btn ghost" style="margin-left:8px">Télécharger (.txt)</button>
      </div>
    </div>

    <div class="footer">Créé pour la conception RF — instantané & simple. — <span style="color:var(--muted)">MDS calculé avec k = 1.380649e-23 J/K</span></div>
  </div>

<script>
// constantes
const kB = 1.380649e-23; // J/K

// utilitaires
function isFiniteNumber(x){ return typeof x === 'number' && isFinite(x); }
function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : NaN; }
function log10(x){ return Math.log(x)/Math.log(10); }
function formatFixed(x, d=2){ return (isFiniteNumber(x)? x.toFixed(d) : '—'); }

// DOM refs
const bwEl   = document.getElementById('bw');
const tempEl = document.getElementById('temp');
const gainEl = document.getElementById('gain');
const nfEl   = document.getElementById('nf');
const ip1El  = document.getElementById('ip1');
const deltaEl= document.getElementById('delta');
const modeEls= document.getElementsByName('mode');
const iip3Div = document.getElementById('iip3row');
const iip3El  = document.getElementById('iip3');
const ip1IsOutput = document.getElementById('ip1_is_output');

const iip3UsedEl = document.getElementById('iip3_used');
const mdsPowEl = document.getElementById('mds_pow');
const mdsExprEl= document.getElementById('mds_expr');
const sfdrEl     = document.getElementById('sfdr');
const resetBtn   = document.getElementById('resetBtn');
const copyBtn    = document.getElementById('copyBtn');
const downloadBtn= document.getElementById('downloadBtn');

// toggle mode UI
function refreshModeUI(){
  const mode = Array.from(modeEls).find(r=>r.checked).value;
  if(mode === 'iip3'){ iip3Div.style.display = 'block'; ip1El.disabled = true; deltaEl.disabled = true; ip1IsOutput.disabled = true; }
  else { iip3Div.style.display = 'none'; ip1El.disabled = false; deltaEl.disabled = false; ip1IsOutput.disabled = false; }
}

// main compute
function compute(){
  // read inputs
  const bw   = toNum(bwEl.value); // Hz
  const tempC= toNum(tempEl.value); // °C
  const gain = toNum(gainEl.value);
  const nf   = toNum(nfEl.value);

  const mode = Array.from(modeEls).find(r=>r.checked).value;

  let iip3_used = NaN;

  if(mode === 'iip3'){
    iip3_used = toNum(iip3El.value);
  } else { // ip1 mode
    let ip1 = toNum(ip1El.value);
    if(ip1IsOutput.checked && isFiniteNumber(gain)) {
      // convert OP1dB (sortie) to IP1dB (entrée)
      ip1 = ip1 - gain;
    }
    const delta = toNum(deltaEl.value);
    const delta_use = Number.isFinite(delta) ? delta : 10.0;
    if(Number.isFinite(ip1)) iip3_used = ip1 + delta_use;
  }

  // convert temperature to Kelvin
  let Tkelvin = NaN;
  if(Number.isFinite(tempC)) Tkelvin = tempC + 273.15;

  // compute MDS = 10*log10(k*T*BW) + 30 + NF
  let mds = NaN;
  if(Number.isFinite(bw) && bw > 0 && Number.isFinite(nf) && Number.isFinite(Tkelvin) && Tkelvin > 0){
    const prod = kB * Tkelvin * bw; // in joules/sec => W
    mds = 10 * log10(prod) + 30 + nf;
  }

  // SFDR = (2/3)*(IIP3 - MDS)
  let sfdr = NaN;
  if(Number.isFinite(iip3_used) && Number.isFinite(mds)) {
    sfdr = (2.0/3.0) * (iip3_used - mds);
  }

  // display
  iip3UsedEl.textContent = (Number.isFinite(iip3_used) ? iip3_used.toFixed(2) + ' dBm' : '—');
  mdsPowEl.textContent = (Number.isFinite(mds) ? mds.toFixed(2) + ' dBm' : '—');
  mdsExprEl.textContent = (Number.isFinite(bw) && Number.isFinite(nf) && Number.isFinite(Tkelvin))
    ? `MDS = 10·log10(${kB}·${Tkelvin.toFixed(3)}·${bw}) + 30 + ${nf} = ${formatFixed(mds,2)} dBm`
    : '';
  sfdrEl.textContent = (Number.isFinite(sfdr) ? sfdr.toFixed(2) + ' dB' : '—');
}

// events
Array.from(modeEls).forEach(r => r.addEventListener('change', ()=>{ refreshModeUI(); compute(); }));
[bwEl, tempEl, gainEl, nfEl, ip1El, deltaEl, iip3El, ip1IsOutput].forEach(el => el.addEventListener('input', compute));
resetBtn.addEventListener('click', ()=>{
  bwEl.value = 1000000; tempEl.value = 20.0; gainEl.value = 30; nfEl.value = 3.0;
  document.querySelector('input[name="mode"][value="ip1"]').checked = true;
  ip1El.value = 18.0; iip3El.value = 28.0; deltaEl.value = 10.0; ip1IsOutput.checked = false;
  refreshModeUI(); compute();
});

// copy results
copyBtn.addEventListener('click', ()=>{
  const txt = [
    `BW: ${bwEl.value} Hz`,
    `Temp: ${tempEl.value} °C`,
    `Gain: ${gainEl.value} dB`, `NF: ${nfEl.value} dB`,
    `IIP3 utilisé: ${iip3UsedEl.textContent}`,
    `MDS (dBm): ${mdsPowEl.textContent}`,
    `SFDR: ${sfdrEl.textContent}`
  ].join('\n');
  navigator.clipboard?.writeText(txt).then(()=> alert('Résultats copiés dans le presse-papier.'), ()=> alert('Impossible de copier.'));
});

// download
downloadBtn.addEventListener('click', ()=>{
  const content = [
    `--- SFDR & MDS calculation ---`,
    `Date: ${new Date().toLocaleString()}`,
    `BW (Hz): ${bwEl.value}`,
    `Temp (°C): ${tempEl.value}`,
    `Gain (dB): ${gainEl.value}`,
    `NF (dB): ${nfEl.value}`,
    `IIP3 utilisé: ${iip3UsedEl.textContent}`,
    `MDS (dBm): ${mdsPowEl.textContent}`,
    `SFDR (dB): ${sfdrEl.textContent}`
  ].join('\n');
  const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'sfdr_mds_results.txt'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
});

// init
refreshModeUI();
compute();
</script>
</body>
</html>
